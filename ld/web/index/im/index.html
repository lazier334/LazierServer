<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>im</title>
    <script type="module">
        import { Workbox } from '/res/workbox/releases/7.3.0/workbox-window.prod.mjs';

        if ('serviceWorker' in navigator) {
            const wb = new Workbox('/sw.js');

            wb.register().then(registration => console.log('SW Ê≥®ÂÜåÊàêÂäü'))
                .catch(err => console.error('SW Ê≥®ÂÜåÂ§±Ë¥•:', err));;
        }
    </script>
    <script>
        // Ê∏ÖÈô§ÁºìÂ≠òÁöÑÂáΩÊï∞
        function clearCaches() {
            return (async () => {
                try {
                    // 1. ÂèñÊ∂àÊ≥®ÂÜåÊâÄÊúâ Service Worker
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                        console.log('Service Worker Â∑≤ÂèñÊ∂àÊ≥®ÂÜå:', registration.scope);
                    }
                    // 2. Ê∏ÖÁêÜÊâÄÊúâÁºìÂ≠ò
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        console.log(`Â∑≤Âà†Èô§ÁºìÂ≠ò: ${cacheName}`);
                    }
                    console.log('SWÊ∏ÖÁêÜÊàêÂäü');
                } catch (err) {
                    console.error('SWÊ∏ÖÁêÜÂ§±Ë¥•:', err);
                    throw err;
                }
            })();
        }
    </script>
    <!-- ÂºïÂÖ•Vue3 -->
    <script src="../res/vue.global.prod.js"></script>
    <!-- ÂºïÂÖ•element-plusÊ†∑ÂºèÊñá‰ª∂ -->
    <link rel="stylesheet" href="../res/index.css" />
    <!-- ÂºïÂÖ•element-plusÁªÑ‰ª∂Â∫ì -->
    <script src="../res/index.full.js"></script>
    <!-- ÂºïÂÖ•axios -->
    <script src="../res/axios.min.js"></script>
    <!-- ÂºïÂÖ•Â§öËØ≠Ë®Ä -->
    <script src="./langs.js"></script>
    <!-- xxhash -->
    <script src="res/xxhash-wasm.js"></script>
    <!-- tus -->
    <script src="res/tus.min.js"></script>
    <!-- CryptoJs -->
    <script src="res/crypto-js.min.js"></script>
    <!-- marked -->
    <script src="../res/marked.min.js"></script>
    <!-- ÂÖ∂‰ªñÊ®°ÂùóÈúÄË¶ÅÂú®Âä†ËΩΩ monaco-editor ‰πãÂâçËøõË°åÂä†ËΩΩÔºåÂê¶ÂàôÂèØËÉΩ‰ºöÂØºËá¥Êó†Ê≥ïÊ≠£Â∏∏Âä†ËΩΩ -->
    <!-- monaco-editor -->
    <script src="https://unpkg.com/monaco-editor/min/vs/loader.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/monaco-editor/min/vs/editor/editor.main.css">
    <!-- monaco-editor Âíå pythen(pyodide) ÈÉΩ‰ªéÁ¨¨‰∏âÊñπÂºïÂÖ• -->
</head>

<body>
    <div id="app">
        <!-- ÈöêËóèÂÜÖÂÆπ -->
        <el-container v-if="!nothidePage.left && !nothidePage.right" class="content">
            <div class="center" style="width: 100%; color: cornflowerblue;">
                <el-text type="primary" :class="nothidePage.bottom ? 'no-concise' : 'concise'"
                    @click="nothidePage.bottom = !nothidePage.bottom">
                    {{ new Date(currentTime).toLocaleString() }}
                </el-text>
            </div>
        </el-container>

        <!-- Â∑¶‰æßÂÜÖÂÆπ -->
        <el-container v-if="nothidePage.left" class="left-container">
            <div class="top-section">
                <el-header>
                    <el-input v-model="searchQuery" :placeholder="i18n('ÊêúÁ¥¢...')" class="input-with-select"
                        @input="handleSearchInput">
                        <template #prepend>
                            <el-avatar v-if="user.showAvatar && typeof user.showAvatar == 'string'"
                                :src="user.showAvatar" @click="login.loginPageVisible=true"></el-avatar>

                            <el-avatar v-else @click="login.loginPageVisible=true">
                                {{user.username}}
                            </el-avatar>
                        </template>
                    </el-input>
                </el-header>
                <div>
                    <div class="list-buts">
                        <el-switch v-model="isShowFriendList" @change="handleSwitchChange('manual')" inline-prompt
                            :active-text="i18n('Áî®Êà∑ÂàóË°®')" :inactive-text="i18n('ËØùÈ¢òÂàóË°®')"
                            style="--el-switch-on-color: #409eff; --el-switch-off-color: #409eff">
                        </el-switch>
                    </div>
                    <el-main>
                        <el-scrollbar v-if="isShowFriendList">
                            <div>
                                <div v-for="item in showOnlineListData" :key="item.userId">
                                    <div class="connect-item single-line-text vertical-center"
                                        :class="{ 'is-selected': onlineSelect.includes(item.userId) }"
                                        @click="handleOnlineSelect(item.userId)">
                                        <el-checkbox class="checkbox-but"
                                            :model-value="onlineSelect.includes(item.userId)"
                                            @click="selectAndChangMode(item.userId, 'online', $event)"></el-checkbox>
                                        <el-avatar :src="item.showAvatar" @click="login.loginPageVisible=true"
                                            size="small"
                                            v-if="item.showAvatar && typeof item.showAvatar == 'string'"></el-avatar>
                                        <el-avatar v-else @click="login.loginPageVisible=true" size="small">
                                            {{item.username}}
                                        </el-avatar>
                                        <el-text class="single-line-text">{{ item.username }}</el-text>
                                    </div>
                                </div>
                            </div>
                        </el-scrollbar>
                        <el-scrollbar v-else>
                            <div v-for="item in showMsgsListData" :key="item.topicId">
                                <div class="connect-item single-line-text"
                                    :class="{ 'is-selected': msgsSelect.includes(item.topicId) }"
                                    @click="handleMsgsSelect(item)">
                                    <div class="message-content">
                                        <el-checkbox class="checkbox-but"
                                            :model-value="msgsSelect.includes(item.topicId)"
                                            @click="selectAndChangMode(item.topicId, 'msgs', $event)"></el-checkbox>
                                        <el-text class="single-line-text">{{ item.name }}</el-text>
                                    </div>
                                    <div class="message-container">
                                        <el-text class="message-content" style="color: #999;">{{ item.lastMsg.content
                                            }}</el-text>
                                        <el-text class="message-time">{{
                                            new Date(item?.lastMsg?.time || 0).toLocaleTimeString().substring(0,5)
                                            }}</el-text>
                                    </div>
                                </div>
                            </div>
                        </el-scrollbar>
                    </el-main>
                </div>
            </div>
        </el-container>

        <!-- Âè≥‰æßÂÜÖÂÆπ-Ê∂àÊÅØÈ°µ -->
        <el-container v-if="nothidePage.right && rightPage.now == rightPage.map.msgs" class="right-container">
            <!-- <div class="msg-head top" :style="`width: ${tableWidth}px;z-index:2;background-color: #fff;`">
                <div class="msg-head-title">{{selectTopic.name}}</div>
            </div> -->
            <div class="header header1">
                <div class="msg-head-title msg-head-title1">
                    <span :class="refreshMsgsTag?'refreshMsgsTag':'re-refreshMsgsTag'" @click="handleRefreshMsgs(this)"
                        :title="i18n('Âà∑Êñ∞')">‚Üª</span>
                    {{selectTopic.name}}
                    <el-text :title="i18n('ÊÄª‰∫∫Êï∞')">({{selectTopic.userTotal}})</el-text>
                </div>
                <!-- Âè≥‰æßÊåâÈíÆ -->
                <div class="header-right1">
                    <el-text type="primary" @click="openTopicOptionsPage(selectTopic)">...</el-text>
                </div>
            </div>
            <div class="auto-height">
                <!-- Âõ†‰∏∫ËôöÊãüÂåñË°®Ê†ºÊúâÈ´òÂ∫¶Â°åÈô∑ÈóÆÈ¢òÔºåÊó†Ê≥ïÊ≠£Â∏∏‰ΩøÁî®ÔºåÊâÄ‰ª•‰ΩøÁî®‰º†ÁªüË°®Ê†ºÔºåÂêéÁª≠ÂèØ‰ª•ËÄÉËôëËá™ÂÆö‰πâËôöÊãüÂåñÂàóË°® -->
                <div v-if="true" class="table-container">
                    <el-table ref="tableRef" :data="messages" style="width: 100%" :height="tableHeight">
                        <!-- Ëá™ÂÆö‰πâÂàó: Ê∂àÊÅØÂÜÖÂÆπ -->
                        <el-table-column>
                            <template #default="{ row: msg, $index: rowIndex }">
                                <div class="msg-container" @mouseover="hoveredRow = rowIndex"
                                    @mouseleave="hoveredRow = null">
                                    <div class="msg" :class="msg.userId === user.userId? 'myMsg myMsgBG' : ''">

                                        <div class="msg-content">
                                            <!-- Ê∫êÁ†Å -->
                                            <div v-if="msg.id != editMsgId">
                                                <pre>{{ msg.content }}</pre>
                                            </div>

                                            <!-- ÁºñËæë -->
                                            <div v-else>
                                                <el-input v-model="msg.content" type="textarea" placeholder=""
                                                    :rows="20<msg.content.split('\n').length ? 20 : (msg.content.split('\n').length < 5 ? 5 : msg.content.split('\n').length)" />
                                            </div>

                                            <!-- È¢ÑËßà -->
                                            <div v-if="messagesPlus?.[msg.id]?.view == 'render'" class="msg-render">
                                                <div v-if="msg.type == 'js' || msg.type == 'py'">
                                                    <iframe frameborder="0" class="msg-preview" src="about:blank"
                                                        @load="runMsgInIframe(msg, $event.target)"></iframe>
                                                </div>
                                                <div v-else-if="msg.type == 'url'">
                                                    <iframe frameborder="0" class="msg-preview"
                                                        :src="msg.content"></iframe>
                                                </div>
                                                <div v-else-if="msg.type == 'image'">
                                                    <el-image :src="fileUrl(msg.content)"
                                                        :preview-src-list="previewTopicList" fit="contain"
                                                        :initial-index="getPreviewTopicListIndex(msg.content)"
                                                        :preview-teleported="true" class="msg-preview preview-image">
                                                        <template #error>
                                                            <!-- Ëá™ÂÆö‰πâÂä†ËΩΩ‰∏≠/Âä†ËΩΩÂ§±Ë¥•ÁöÑÂç†‰ΩçÂÜÖÂÆπÔºàÂèØÈÄâÔºâ -->
                                                            <div slot="error" class="image-error-slot">
                                                                {{fileUrl(url)}}
                                                            </div>
                                                        </template>
                                                    </el-image>
                                                </div>
                                                <div v-else-if="msg.type == 'md' || msg.type == 'markdown'">
                                                    <div v-html="renderedMarkdownByMsg(msg)" class="msg-preview"></div>
                                                </div>
                                                <div v-else>
                                                    <pre>{{ msg.content }}</pre>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="msg-buts">
                                            <el-button v-if="msg.senderror !== undefined" size="small">
                                                {{ msg.senderror === false ? ' „Äá' : 'X' }} </el-button>

                                            <template
                                                v-for="(but, index) in (msg.userId === user.userId ? msgButsMe : msgButsUser)">
                                                <el-button :key="index"
                                                    v-if="typeof but?.visible == 'function' ? but.visible(msg) : true"
                                                    class="copy-button" size="small" @click="but.click(msg)"
                                                    :style="but.style||''" :title="but.title(msg)">
                                                    {{ typeof but.getBody == "function" ? (but.getBody(msg)
                                                    ??
                                                    but.title(msg)) : but.title(msg)}}
                                                </el-button>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </div>

            <div class="bottom-section center" style="padding-top: 10px;">
                <div class="inmsg-container">
                    <el-button v-if="currentRows < currentRowsFull"
                        @click="currentRows < currentRowsFull ? currentRows = currentRowsFull : ''" round
                        style="margin-right:10px;">
                        <span class="flip-vertical">‚åµ</span></el-button>
                    <div class="inmsg-input">
                        <div>
                            <el-input v-show="!useEditor" v-model="inmsg" class="no-resize"
                                :autosize="{ minRows: 1, maxRows: 20 }" autosize ref="inputRef" @input="checkRows"
                                type="textarea" :placeholder="i18n('ËæìÂÖ•Ê∂àÊÅØ...')"></el-input>
                            <div v-show="useEditor" id="editor-container" class="cancelCenter">
                                <div ref="monacoEditor" class="monaco-editor-replacement"
                                    :style="{ height: editorHeight + 'px', width: '99%' }">
                                    <!-- ËøôÈáåÂè™Ë¶ÅÂÆΩÂ∫¶‰∏çÊòØ100%Â∞±Ê≤°ÈóÆÈ¢ò -->
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="image-container">
                                <!-- ÂçïÂº†ÂõæÁâáÈ¢ÑËßà -->
                                <el-image v-for="(url, index) in uploadedFiles" :key="index" :src="fileUrl(url)"
                                    :preview-src-list="previewList" :initial-index="index" fit="contain"
                                    :preview-teleported="true" class="min-img preview-image">
                                    <template #error>
                                        <!-- Ëá™ÂÆö‰πâÂä†ËΩΩ‰∏≠/Âä†ËΩΩÂ§±Ë¥•ÁöÑÂç†‰ΩçÂÜÖÂÆπÔºàÂèØÈÄâÔºâ -->
                                        <div slot="error" class="image-error-slot">
                                            {{fileUrl(url)}}
                                        </div>
                                    </template>
                                </el-image>
                                <el-button v-if="0 < uploadedFiles.length" type="danger" size="small"
                                    @click="clearUploadedFiles">{{i18n('Ê∏ÖÈô§')}}</el-button>
                                <el-button v-if="0 < uploadedFiles.length" type="primary" size="small"
                                    @click="sendFiles">{{i18n('ÂçïÁã¨ÂèëÈÄÅ')}}</el-button>
                            </div>
                        </div>
                    </div>
                    <div v-if="currentRows < currentRowsFull" class="inmsg-sendbtn" style="margin-left:10px;">
                        <el-button round type="primary" @click="sendMsgToServer()">{{i18n('ÂèëÈÄÅ')}}</el-button>
                    </div>
                </div>
                <div v-if="currentRowsFull <= currentRows" class="inmsg-btns">
                    <div>
                        <el-button round @click="currentRows=1">‚åµ</el-button>
                    </div>
                    <div>
                        <el-select v-model="msgTemplate.type" filterable allow-create default-first-option
                            :reserve-keyword="false" placeholder="Choose tags for your article" style="width: 70px">
                            <el-option-group :label="i18n('Ê∂àÊÅØÁ±ªÂûã')">
                                <el-option v-for="item in msgTemplate.typeList" :key="item.value" :label="item.label"
                                    :value="item.value" />
                            </el-option-group>
                        </el-select>
                    </div>
                    <div>
                        <el-button type="primary" round @click="selectFile">
                            {{fileName || i18n('‰∏ä‰º†Êñá‰ª∂')}}</el-button>
                        <input type="file" multiple id="fileInput" class="hide" @change="handleFileChange" />
                        <div>
                            <el-button v-if="0 < files.length" type="success" size="small"
                                @click="uploadFiles">{{i18n('‰∏ä‰º†')}}</el-button>
                            <el-button v-if="0 < files.length" type="danger" size="small"
                                @click="clearFiles">{{i18n('Ê∏ÖÈô§')}}</el-button>
                        </div>
                    </div>
                    <div>
                        <el-button type="primary" round @click="sendMsgToServer()">{{i18n('ÂèëÈÄÅ')}}</el-button>
                    </div>
                    <div>
                        <el-button type="primary" round @click="toggleNativeFullscreen()">{{i18n('ÂÖ®Â±è')}}</el-button>
                    </div>
                    <div>
                        <el-button type="primary" round @click="useEditor=!useEditor">{{i18n('ÂàáÊç¢ËæìÂÖ•Ê°Ü')}}</el-button>
                    </div>
                </div>
            </div>
        </el-container>

        <!-- Âè≥‰æßÂÜÖÂÆπ-‰ø°ÊÅØÈ°µ -->
        <el-container v-if="nothidePage.right && rightPage.now == rightPage.map.showUser" class="right-container">
            <div class="header">
                <div class="msg-head-title">
                    {{showUser?.userId == user.userId ? i18n('‰∏™‰∫∫‰ø°ÊÅØ') : ( (user.superAdmin || user.isAdmin) ?
                    i18n('ÁÆ°ÁêÜÁî®Êà∑‰ø°ÊÅØ') : i18n('Áî®Êà∑‰ø°ÊÅØ'))}}
                </div>
            </div>
            <!-- ‰∏™‰∫∫‰ø°ÊÅØ -->
            <div v-if="showUser?.userId == user.userId" class="user-info-card">
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑ID') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ showUser?.userId }}</el-col>
                </el-row>
                <el-row type="flex" align="middle">
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑Â§¥ÂÉèÂú∞ÂùÄ') + ': '}}</strong></el-col>
                    <el-col :span="14">
                        <el-input v-model="showUser.avatar" :placeholder="showUser.avatar" clearable
                            @change="handleEditAvatarChange"></el-input>
                    </el-col>
                    <el-col :span="2" style="text-align: center;">
                        <el-avatar v-if="showUser.showAvatar && typeof showUser.showAvatar == 'string'"
                            :src="showUser.showAvatar"></el-avatar>
                        <el-avatar v-else>...</el-avatar>
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑Âêç') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        <el-input v-model="showUser.username" :placeholder="showUser.username" clearable></el-input>
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑Áä∂ÊÄÅ') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        <el-input v-model="showUser.status" :placeholder="showUser.status" clearable></el-input>
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        {{ new Date(showUser?.lastUpdateTime ).toLocaleString() }}
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÊòØÂê¶ÁÆ°ÁêÜÂëò') + ': '}}</strong></el-col>
                    <el-col :span="16"><el-switch v-model="showUser.isAdmin" disabled></el-switch></el-col>
                </el-row>
                <el-row v-if="showUser.superAdmin">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò') + ': '}}</strong></el-col>
                    <el-col :span="16"><el-switch v-model="showUser.superAdmin" disabled></el-switch></el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ËøáÊúüÊó∂Èó¥') + ': '}}</strong></el-col>
                    <el-col :span="16"><el-date-picker v-model="showUser.deadline" type="datetime"
                            :placeholder="i18n('ÈÄâÊã©Êó•ÊúüÂíåÊó∂Èó¥')" disabled></el-date-picker></el-col>
                </el-row>
                <el-row>
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÊóßÂØÜÁ†Å') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        <el-input type="password" v-model="showUser.oldPassword" :placeholder="i18n('ÊóßÂØÜÁ†Å')"
                            clearable></el-input>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Êñ∞ÂØÜÁ†Å') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        <el-input type="password" v-model="showUser.password" :placeholder="i18n('Êñ∞ÂØÜÁ†Å')"
                            clearable></el-input>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÂÜçÊ¨°ËæìÂÖ•Êñ∞ÂØÜÁ†Å') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        <el-input type="password" v-model="showUser.password2" :placeholder="i18n('ÂÜçÊ¨°ËæìÂÖ•Êñ∞ÂØÜÁ†Å')"
                            clearable></el-input>
                    </el-col>
                </el-row>
            </div>
            <!-- ÁÆ°ÁêÜÁî®Êà∑‰ø°ÊÅØ
                Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂèØÊõ¥ÊîπÔºöÂ§¥ÂÉè„ÄÅÂêçÁß∞„ÄÅÁÆ°ÁêÜÂëò„ÄÅË∂ÖÁ∫ßÁÆ°ÁêÜÂëò„ÄÅÂØÜÁ†Å
              -->
            <div v-else-if="user.superAdmin || user.isAdmin" class="user-info-card">
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑ID') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ showUser?.userId }}</el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑Â§¥ÂÉèÂú∞ÂùÄ') + ': '}}</strong></el-col>
                    <el-col :span="14">
                        <el-input v-model="showUser.avatar" :placeholder="showUser.avatar" clearable
                            @change="handleEditAvatarChange" :disabled="!user.superAdmin"></el-input>
                    </el-col>
                    <el-col :span="2" style="text-align: center;">
                        <el-avatar v-if="showUser.showAvatar && typeof showUser.showAvatar == 'string'"
                            :src="showUser.showAvatar"></el-avatar>
                        <el-avatar v-else>...</el-avatar>
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑Âêç') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        <el-input v-model="showUser.username" :placeholder="showUser.username" clearable
                            :disabled="!user.superAdmin"></el-input>
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑Áä∂ÊÄÅ') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        <el-input v-model="showUser.status" :placeholder="showUser.status" clearable></el-input>
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        {{ new Date(showUser?.lastUpdateTime ).toLocaleString() }}
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÊòØÂê¶ÁÆ°ÁêÜÂëò') + ': '}}</strong></el-col>
                    <el-col :span="16"><el-switch v-model="showUser.isAdmin"
                            :disabled="!user.superAdmin"></el-switch></el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò') + ': '}}</strong></el-col>
                    <el-col :span="16"><el-switch v-model="showUser.superAdmin"
                            :disabled="!user.superAdmin"></el-switch></el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ËøáÊúüÊó∂Èó¥') + ': '}}</strong></el-col>
                    <el-col :span="16"><el-date-picker v-model="showUser.deadline" type="datetime"
                            :placeholder="i18n('ÈÄâÊã©Êó•ÊúüÂíåÊó∂Èó¥') + ': '"></el-date-picker></el-col>
                </el-row>
                <el-row v-if="user.superAdmin">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Êñ∞ÂØÜÁ†Å') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        <el-input v-model="showUser.password" :placeholder="i18n('Êñ∞ÂØÜÁ†Å')" clearable
                            :disabled="!user.superAdmin"></el-input>
                    </el-col>
                </el-row>
            </div>
            <!-- Áî®Êà∑‰ø°ÊÅØ -->
            <div v-else class="user-info-card">
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑ID') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ showUser?.userId }}</el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑Âêç') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ showUser?.username }}</el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑Áä∂ÊÄÅ') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ showUser?.status }}</el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        {{ new Date(showUser?.lastUpdateTime ).toLocaleString() }}
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÊòØÂê¶ÁÆ°ÁêÜÂëò') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ showUser?.isAdmin ? 'ÊòØ' : 'Âê¶' }}</el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ showUser?.superAdmin ? 'ÊòØ' : 'Âê¶' }}</el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ËøáÊúüÊó∂Èó¥') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ (typeof showUser?.deadline == 'number' ? new
                        Date(showUser?.deadline||0).toLocaleString() : showUser?.deadline)
                        }}</el-col>
                </el-row>
            </div>
            <div class="bottom-section center" v-if="showUser?.userId == user.userId">
                <el-button type="primary" @click="updateAccount(showUser)">{{i18n('‰øÆÊîπËµÑÊñô')}}</el-button>
                <el-button type="primary" @click="updatePassword(showUser)">{{i18n('‰øÆÊîπÂØÜÁ†Å')}}</el-button>
            </div>
            <div class="bottom-section center"
                v-if="showUser?.userId != user.userId && (user.superAdmin || user.isAdmin)">
                <el-button type="primary" @click="updateAccount(showUser)">{{i18n('‰øÆÊîπËµÑÊñô')}}</el-button>
                <el-button type="primary" @click="handleOnlineSelect(showUser.userId)">{{i18n('ÈáçÁΩÆËµÑÊñô')}}</el-button>
            </div>
        </el-container>

        <!-- Âè≥‰æßÂÜÖÂÆπ-ËØùÈ¢òÈÖçÁΩÆÈ°µ -->
        <el-container v-if="nothidePage.right && rightPage.now == rightPage.map.editTopic" class="right-container">
            <!-- ËØùÈ¢òÁöÑÂü∫Êú¨‰ø°ÊÅØ -->
            <div class="user-info-card">
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ËØùÈ¢òID') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ editTopic?.topicId }}</el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ËØùÈ¢òÊ†áÈ¢ò') + ': '}}</strong></el-col>
                    <el-col :span="16">
                        <!-- ÂπøÂú∫Ê®°ÂºèÊàñÁÆ°ÁêÜÂëòÊùÉÈôê -->
                        <el-input v-model="editTopic.name" :placeholder="i18n('Êñ∞ÂØÜÁ†Å')" clearable
                            :disabled="!(editTopic.notAdmin || editTopic?.admins?.includes(user.userId))"></el-input>
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('‰∫∫ÂëòÊÄªÊï∞') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ editTopic?.userTotal }}</el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÁÆ°ÁêÜÂëòÊÄªÊï∞') + ': '}}</strong></el-col>
                    <el-col :span="16">{{ editTopic?.admins?.length }}</el-col>
                </el-row>
            </div>
            <!-- ËØùÈ¢òÁöÑÁî®Êà∑‰ø°ÊÅØ -->
            <div class="user-info-card">
                <!-- <div class="connect-item single-line-text vertical-center"
                    @click="handleOnlineSelect(editTopic?.admins?.[0])">
                    Áæ§‰∏ª‰ø°ÊÅØ
                    <el-avatar :src="item.showAvatar" @click="login.loginPageVisible=true" size="small"
                        v-if="item.showAvatar && typeof item.showAvatar == 'string'"></el-avatar>
                    <el-avatar v-else @click="login.loginPageVisible=true" size="small">
                        {{item.username}}
                    </el-avatar>
                    <el-text class="single-line-text">{{ item.username }}</el-text>
                </div>
                -->
                <!-- TODO Áæ§‰∏ªÂèØ‰ª•ËÆæÁΩÆÁÆ°ÁêÜÂëò -->
                <!-- TODO ÊôÆÈÄöÁî®Êà∑ÂèØ‰ª•ÊãâÂÖ∂‰ªñÁî®Êà∑ËøõÊù• -->
                <!-- TODO ÁÆ°ÁêÜÂëòÂèØ‰ª•ËÆæÁΩÆÁî®Êà∑ÂèØËßÅÊ∂àÊÅØËåÉÂõ¥ -->
            </div>
            <!-- ËØùÈ¢òÁöÑÊùÉÈôê‰ø°ÊÅØ -->
            <div class="user-info-card">
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('ÂπøÂú∫Ê®°Âºè') + ': '}}</strong></el-col>
                    <!-- ÂπøÂú∫Ê®°ÂºèÊàñÁæ§‰∏ªÊùÉÈôê -->
                    <el-col :span="16"><el-switch v-model="editTopic.notAdmin"
                            :disabled="!(editTopic.notAdmin || user.userId == editTopic?.admins?.[0])"></el-switch></el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-col :span="8" class="user-info-item-name"><strong>{{i18n('Áî®Êà∑Êãâ‰∫∫Âä†ÂÖ•') + ': '}}</strong></el-col>
                    <!-- ÂπøÂú∫Ê®°ÂºèÊàñÁÆ°ÁêÜÂëòÊùÉÈôê -->
                    <el-col :span="16"><el-switch v-model="editTopic.addMode"
                            :disabled="!(editTopic.notAdmin || editTopic?.admins?.includes(user.userId))"></el-switch></el-col>
                </el-row>
            </div>
            <div class="bottom-section center">
                <el-button v-if="editTopic.notAdmin || user.userId==editTopic?.admins?.[0]" type="primary"
                    @click="onUpdateTopic(editTopic)">{{i18n('‰øÆÊîπËØùÈ¢ò')}}</el-button>

                <el-button v-if="user.userId==editTopic?.admins?.[0]" type="danger"
                    @click="onDeleteTopic(editTopic)">{{i18n('Âà†Èô§ËØùÈ¢ò')}}</el-button>

                <el-button v-if="user.userId!=editTopic?.admins?.[0]" type="danger"
                    @click="onExitTopic(editTopic)">{{i18n('ÈÄÄÂá∫ËØùÈ¢ò')}}</el-button>
            </div>
        </el-container>

        <!-- Âè≥‰æßÂÜÖÂÆπ-Ê¨¢ËøéÈ°µ -->
        <el-container v-if="nothidePage.right && rightPage.now == rightPage.map.welcome" class="right-container">
            <div class="header">
                <div class="msg-head-title">im</div>
            </div>
            <div class="content">
                <div class="center2" style="color: cornflowerblue;">{{i18n('Ê¨¢Ëøé‰ΩøÁî®ËØ•È°πÁõÆÔºÅ')}}</div>
            </div>
            <div class="bottom-section center">
                <el-button type="primary" @click="clickWelcome">{{ startNumber }}</el-button>
            </div>
        </el-container>

        <!-- Âè≥‰æßÂÜÖÂÆπ-ËÆæÁΩÆÈ°µ -->
        <el-container v-if="nothidePage.right && rightPage.now == rightPage.map.setting" class="right-container">
            <div class="header">
                <div class="msg-head-title">{{i18n('ËÆæÁΩÆ')}}</div>
            </div>
            <div class="content">
                <div class="funs center settings-buts">
                    <template v-for="(but, index) in settingsButs">
                        <el-button :key="index" v-if="typeof but?.visible == 'function' ? but.visible(msg) : true"
                            class="copy-button" type="info" size="small" round @click="but.click(msg)"
                            :style="but.style||''" :title="but.title(msg)">
                            {{ typeof but.getBody == "function" ? (but.getBody(msg) ??
                            but.title(msg)) : but.title(msg)}}
                        </el-button>
                    </template>
                </div>
                <div>
                    <el-input v-model="cryptoKey" type="text" :input-style="{ textAlign: 'center' }"
                        :placeholder="i18n('Âä†Ëß£ÂØÜÁöÑÁßòÈí•')"></el-input>
                    <div class="crypto-container">
                        <div class="crypto-section">
                            <el-input v-model="originData" type="textarea" :placeholder="i18n('ÈúÄË¶ÅÂä†ÂØÜÁöÑÊï∞ÊçÆ')"></el-input>
                            <div class="center">
                                <el-button type="primary" size="small" round
                                    @click="onCryptoData()">{{i18n('Âä†ÂØÜ')}}</el-button>
                                <el-button type="primary" size="small" round
                                    @click="copyOriginData()">{{i18n('Â§çÂà∂')}}</el-button>
                            </div>
                        </div>

                        <div class="crypto-section">
                            <el-input v-model="cryptoData" type="textarea" :placeholder="i18n('ÈúÄË¶ÅËß£ÂØÜÁöÑÊï∞ÊçÆ')"></el-input>
                            <div class="center">
                                <el-button type="primary" size="small" round
                                    @click="onCryptoData('decode')">{{i18n('Ëß£ÂØÜ')}}</el-button>
                                <el-button type="primary" size="small" round
                                    @click="copyCryptoData()">{{i18n('Â§çÂà∂')}}</el-button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÁâàÊùÉÊ†è -->
                <div class="copyright">
                    <iframe src="/system/copyright" frameborder="0" scrolling="no"
                        style="width: 100%; height: 50px;"></iframe>
                </div>
            </div>
            <div class="bottom-section center">
            </div>
        </el-container>

        <!-- Â∫ïÈÉ® -->
        <div class="bottom-controls" v-if="nothidePage.bottom">
            <div class="funs bottom">
                <template v-if="isShowFriendList ? !(0 < onlineSelect.length) : !(0 < msgsSelect.length)">
                    <el-button type="info" size="small" round @click="rightPage.now = rightPage.map.setting">{{
                        i18n('‚öô ËÆæÁΩÆ')}}</el-button>
                    <el-button type="info" size="small" round @click="onReload()">{{i18n('‚Üª Âà∑Êñ∞')}}</el-button>
                </template>

                <!-- Áî®Êà∑ÁïåÈù¢ -->
                <template v-if="isShowFriendList">
                    <el-button v-if="user.superAdmin" type="success" size="small" round
                        @click="sa_onlineList(onlineSelect)">{{i18n('@ ÂÖ®ÈÉ®Áî®Êà∑')}}</el-button>
                </template>

                <template v-if="0 < onlineSelect.length && isShowFriendList">
                    <el-button type="primary" size="small" round @click="onlineSelect.splice(0,onlineSelect.length)">{{
                        i18n('x ÂèñÊ∂à')}}</el-button>
                    <el-button type="success" size="small" round @click="createTopic()">{{i18n('+ ËØùÈ¢ò')}}</el-button>
                    <el-button v-if="user.superAdmin || user.isAdmin" type="danger" size="small" round
                        @click="sa_logoutAll(onlineSelect)">{{i18n('‚Üì Ê≥®ÈîÄ')}}</el-button>
                </template>

                <!-- Ê∂àÊÅØÁïåÈù¢ -->
                <template v-if="!isShowFriendList">
                    <el-button v-if="user.superAdmin" type="success" size="small" round
                        @click="sa_topicList(onlineSelect)">{{i18n('@ ÂÖ®ÈÉ®ËØùÈ¢ò')}}</el-button>
                </template>
                <template v-if="0 < msgsSelect.length && !isShowFriendList">
                    <el-button type="primary" size="small" round @click="msgsSelect.splice(0,msgsSelect.length)">{{
                        i18n('x ÂèñÊ∂à')}}</el-button>
                    <el-button type="danger" size="small" round @click="deleteTopic()">{{i18n('- ËØùÈ¢ò')}}</el-button>
                </template>

                <el-button type="info" size="small" round @click="changeNothidePage(1)">{{i18n('üëÅ Â∑¶')}}</el-button>
                <el-button type="info" size="small" round @click="changeNothidePage(0)">{{i18n('üëÅ Âè≥')}}</el-button>
            </div>
        </div>

        <!-- login page -->
        <el-dialog v-model="login.loginPageVisible"
            :title="user.username ? i18n('Áî®Êà∑') + ': ' + user.username : i18n('ÁôªÂΩï')" width="400px">
            <el-form :model="login.form" :rules="login.rules" ref="loginForm" label-width="80px">
                <!-- Áî®Êà∑Âêç -->
                <el-form-item :label="i18n('Áî®Êà∑Âêç', true)" prop="username">
                    <el-input v-model="login.form.username" :placeholder="i18n('ËØ∑ËæìÂÖ•‰Ω†ÁöÑÁî®Êà∑Âêç')"></el-input>
                </el-form-item>
                <!-- ÂØÜÁ†Å -->
                <el-form-item :label="i18n('ÂØÜÁ†Å', true)" prop="password">
                    <el-input v-model="login.form.password" type="password" :placeholder="i18n('ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂØÜÁ†Å')"
                        @keyup.enter.native="handlePasswordEnter()"></el-input>
                </el-form-item>
                <!-- ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å -->
                <el-form-item v-if="login.register" :label="i18n('ÂØÜÁ†Å', true)" prop="password">
                    <el-input v-model="login.form.password2" type="password" :placeholder="i18n('ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å')"
                        @keyup.enter.native="handlePasswordEnter('reg')"></el-input>
                </el-form-item>
                <!-- ÁôªÂΩïÊåâÈíÆ -->
                <el-form-item>
                    <template #label>
                        <el-checkbox v-model="login.register">
                            <el-text size="small">{{i18n('Ê≥®ÂÜå')}}</el-text>
                        </el-checkbox>
                    </template>
                    <el-button v-if="login.register" type="success" @click="handleRegister">{{i18n('Ê≥®ÂÜå')}}</el-button>
                    <el-button v-else type="primary" @click="handleLogin">{{i18n('ÁôªÂΩï')}}</el-button>
                    <el-button v-if="user.userId != -1" type="danger" @click="handleLogout">{{i18n('ÈÄÄÂá∫ÁôªÂΩï')}}</el-button>
                    <el-button type="info" @click="login.loginPageVisible = false">{{i18n('ÂèñÊ∂à')}}</el-button>
                </el-form-item>
                <el-text type="info" size="small">{{version}}</el-text>
            </el-form>
        </el-dialog>
    </div>
</body>

</html>

<style>
    .concise {
        font-size: 30px;
        transform: scale(1.1);
        transition: font-size 2s ease-in-out, transform 2s ease-in-out;
    }

    .no-concise {
        font-size: 16px;
        transform: scale(1);
        transition: font-size 2s ease-in-out, transform 2s ease-in-out;
    }

    body {
        margin: 0;
        padding: 10px 0;
    }

    #app {
        display: flex;
    }

    .left-container,
    .right-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 92vh;
        background-color: white;
        z-index: 0;
    }

    .left-container {
        width: 30%;
        /* border-right: 1px solid #ccc; */
    }

    .right-container {
        width: 70%;
        margin: 0 5px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 16px;
        z-index: 2;
    }

    .top-section {
        flex: 1;
        overflow: auto;
    }

    .bottom-section {
        margin-top: auto;
    }

    .bottom-controls {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 1;
    }

    .auto-height {
        flex: 1;
        overflow: auto;
    }

    .table-container {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .connect-item {
        border-bottom: 1px solid #ccc;
        border-radius: 5px;
        padding: 2px 10px;
        margin: 3px 0;
    }

    .bottom {
        position: absolute;
        bottom: 0;
    }

    .top {
        position: absolute;
        top: 0;
    }

    .funs {
        /* background-color: #fff; */
        padding: 5px;
    }

    /* 
    .funs>button {
        margin-left: 5px !important;
        margin: 0px 10px;
    } */

    .inmsg {
        bottom: 10px;
        z-index: 3;
    }

    .no-resize .el-textarea__inner {
        resize: none;
    }

    .msg-head {
        z-index: 1;
        flex: 1;
        padding-top: 10px;
    }

    .header1 {
        display: flex;
        align-items: center;
    }

    .msg-head-title {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
    }

    .msg-head-title {
        flex: 1;
    }

    .header-right1 {
        margin-left: auto;
    }

    .inmsg-container {
        display: flex;
        align-items: center;
        overflow: hidden;
        width: 100%;
        background-color: #fffffe;
    }

    .inmsg-input {
        flex: 1;
    }

    .inmsg-sendbtn {
        display: flex;
        flex-shrink: 0;
        overflow: hidden;
    }

    .inmsg-btns {
        border-top: 1px solid #ebeef5;
        margin-top: 5px;
        padding-top: 5px;
        text-align: left;

    }

    .inmsg-btns>* {
        margin: 2px !important;
    }

    .inmsg-btns>div {
        display: inline-block;
    }

    .msg-container {
        width: 100%;
        padding: 2px 20px;
    }

    .msg {
        padding: 2px 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .myMsg {
        right: 0;
        text-align: right;
    }

    .myMsgBG {
        background-color: #fafafa;
    }

    .table-container .el-table-v2 .el-table-v2__row {
        border-bottom: none;
    }

    .table-container .el-table-v2 {
        border: 1px solid #dcdfe6;
    }

    .el-input-group__prepend {
        padding: 3px;
        background-color: #ff000000;
    }

    .el-main {
        padding-top: 0;
    }

    .list-buts {
        text-align: center;
    }

    .msg-buts>* {
        margin: 0 3px;
        margin-left: 0 !important;
    }

    .inline-div {
        display: inline-block;
        margin: 0 0;
    }

    .checkbox-but {
        margin-right: 5px !important;
    }

    .connect-item .checkbox-but {
        visibility: hidden;
    }

    .connect-item:hover .checkbox-but {
        visibility: visible;
    }

    .connect-item.is-selected .checkbox-but {
        visibility: visible;
    }

    .single-line-text {
        border-radius: 5px;
        border-bottom: 1px solid transparent;
        transition: border-bottom-color 0.3s ease;
    }

    .single-line-text:hover {
        border-bottom: 1px solid #409eff;
    }

    .message-container {
        display: flex;
        width: 100%;
        align-items: center;
        gap: 8px;
    }

    .message-content {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .message-time {
        flex-shrink: 0;
        font-size: 30%;
        color: #999;
    }

    .msg-content {
        text-align: left;
    }

    .el-col {
        margin: 5px 0;
    }

    .el-col:first-child {
        margin-top: 0;
    }

    .el-col:last-child {
        margin-bottom: 0;
    }

    .center {
        text-align: center;
    }

    .center2 {
        text-align: center;
        margin-top: 50%;
    }

    .settings-buts>button {
        margin: 5px;
    }

    pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-x: auto;
    }

    .flip-vertical {
        display: inline-block;
        transform: rotate(180deg);
    }

    .crypto-container {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        width: 100%;
    }

    .crypto-section {
        display: flex;
        flex-direction: column;
        flex: 1;
        gap: 10px;
    }

    .refreshMsgsTag {
        display: inline-block;
        color: #409eff;
        transition: transform 0.5s ease;
        /* Âπ≥ÊªëËøáÊ∏° */
    }

    .re-refreshMsgsTag {
        display: inline-block;
        color: #409eff;
        animation: rotate3 1s ease-in-out;
        /* 1ÁßíÂÜÖÂÆåÊàê3ÂúàÊóãËΩ¨ */
        transform: rotate(1080deg);
        /* ‰øùÊåÅÊúÄÁªàÁä∂ÊÄÅ */
    }

    @keyframes rotate3 {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(1080deg);
            /* 360¬∞ √ó 3 = 1080¬∞ */
        }
    }

    .hide {
        display: none;
    }

    .min-img {
        margin: 3px;
        width: 10%;
        height: 10%;
    }

    .image-error-slot {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;

        /* ÂÖ∂‰ªñÊ†∑Âºè */
        font-size: 10px;
        max-height: 3.6em;
        line-height: 1.2;
        word-break: break-all;
    }

    .msg-render {
        border: 1px solid #000;
        border-radius: 5px;
    }

    .msg-preview {
        width: 100%;
    }
</style>
<style scoped>
    .monaco-editor-replacement {
        width: 100%;
        max-width: 100%;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        transition: border-color 0.2s, height 0.2s ease;
        overflow: hidden;
    }

    .monaco-editor-replacement:hover {
        border-color: #c0c4cc;
    }

    .monaco-editor-replacement:focus-within {
        border-color: #409eff;
        outline: none;
    }

    .cancelCenter {
        text-align: left;
    }
</style>

<style>
    .vertical-center {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .user-info-item-name {
        text-align: right;
        padding-right: 10px;
    }
</style>

<script>
    /** Ê∂àÊÅØÁ±ªÂûã */
    const messageType = {
        id: '#',        // Ê∂àÊÅØid
        time: 0,        // ÂèëÈÄÅÊó∂Èó¥
        userId: -1,     // Áî®Êà∑id
        content: '',    // Ê∂àÊÅØÂÜÖÂÆπ
        type: 'txt',    // Á±ªÂûã
        updateTime: 0   // Ê∂àÊÅØÊõ¥Êñ∞Êó∂Èó¥
    };

    /** ËØùÈ¢òÁ±ªÂûã */
    const topicType = {
        auths: {
        },
        admins: [
            // Á¨¨‰∏Ä‰∏™ÁÆ°ÁêÜÂëòÊòØÊåÅÊúâËÄÖ
        ],
        topicId: -1,
        name: 'topic',
        lastMsg: messageType,
        createTime: 0,
        userTotal: 0,
    };

    const { createApp, ref, reactive } = Vue;
    const { ElContainer, ElAside, ElMain, ElMenu, ElMenuItem, ElMessage, ElMessageBox, ElImageViewer } = ElementPlus;

    try {
        if (typeof i18n != 'function') throw new Error('i18n is not a function');
    } catch {
        console.warn('Êó†ÊïàÁöÑÂ§öËØ≠Ë®ÄÊ®°ÂùóÔºå‰ΩøÁî®ÈªòËÆ§ÁöÑËØ≠Ë®Ä');
        i18n = (t) => t;
    }

    var showNotLoginLog = false;
    var tableRef = null;
    // const showLog = console.log;
    const showLog = () => { };
    const API_PREFIX = '/im';
    var tableContainerE = document.querySelector('.table-container');
    var scanTableContainerTime = Date.now();
    var leftContainerE = document.querySelector('.left-container');
    var scanLeftContainerTime = Date.now();
    var requesting = {};
    var loginState = ref(false);
    var monacoEditor = null;
    var languageMap = {
        'text': 'plaintext',
        'js': 'javascript',
        'py': 'python',
        'md': 'markdown',
    };
    var runMsgMap = {
        'js'(code) {
            let re;
            try {
                re = eval(code);
            } catch (error) {
                re = (error.message + '\n' + error.stack).split(location.origin).join('');
                const i = re.lastIndexOf('at Proxy.runMsg (/im/index.html');
                if (i > 0) re = re.substring(0, i);
            }
            return re;
        },
        async 'py'(code) {
            let re;
            try {
                re = await pyEval(code);
            } catch (error) {
                re = (error.message + '\n' + error.stack).split(location.origin).join('');
                const i = re.lastIndexOf('at Proxy.runMsg (/im/index.html');
                if (i > 0) re = re.substring(0, i);
            }
            return re;
        },
        'image': null,
        'file': null,
        'md': parseMarked,
        'markdown': parseMarked,
        'music': null,
        'video': null,
        'text': null,
        'url': null,
    };
    const RightPageMap = {
        msgs: 'msgs',
        welcome: 'welcome',
        showUser: 'showUser',
        setting: 'setting',
        editTopic: 'editTopic',
    };

    function delay(ms) {
        return new Promise((resolve) => {
            setTimeout(resolve, ms);
        });
    }
    /**
     * Êúâ‰∏Ä‰∏™bugÔºå‰º†ÈÄíÁöÑ fetchPromise Â∑≤ÁªèÂèëËµ∑‰∫ÜËØ∑Ê±ÇÔºåÊâÄ‰ª•Âú®Ê≠ªÂæ™ÁéØ‰∏≠‰ºöÂØºËá¥Êúâ‰∏ÄÂ†ÜËØ∑Ê±ÇÔºåÂ∞Ü fetchPromise Êîπ‰∏∫‰∏Ä‰∏™Ëé∑Âèñ promise ÁöÑÂáΩÊï∞
     * @param {()=>Promise} getFetchPromise
     * @param {string} msg
     * @param {(error:Error)=>void} errorCallback
     * @returns {Promise} 
     */
    function warpFetch(getFetchPromise, msg, errorCallback) {
        if (typeof window.requesting != 'object' || window.requesting == null) requesting = {};
        if (requesting[msg]) return delay(1);
        // Â¶ÇÊûúÊú™ÁôªÂΩïÔºåËÄå‰∏îmsgÂºÄÂ§¥‰∏çÊòØ # ÈÇ£‰πàÂ∞±‰ºöË¢´ÊãíÁªùËØ∑Ê±Ç
        if (!(loginState.value || (typeof msg == 'string' && msg.startsWith('#')))) {
            return delay(5000).then((res) => {
                if (showNotLoginLog) {
                    throw new Error(loginState.value ? i18n('ÂèñÊ∂àÊú™ÁôªÂΩïÊó∂ÁöÑËØ∑Ê±Ç') : i18n('Êú™ÁôªÂΩï'))
                }
            });
        }
        showLog('ËØ∑Ê±Ç‰∏≠...', msg, requesting[msg]);
        requesting[msg] = true;

        return getFetchPromise().then(async response => {
            // Ê£ÄÊü•ÂìçÂ∫îÊòØÂê¶ÊàêÂäü
            if (!response.ok) {
                throw new Error(i18n('ÂìçÂ∫î‰∏çÊòØokÁä∂ÊÄÅ'));
            }
            showLog('ËØ∑Ê±ÇÂÆåÊàê' + msg);
            // Â∞ÜÂìçÂ∫îËß£Êûê‰∏∫ÊñáÊú¨
            return await response.text();
        }).then(text => {
            let json;
            try {
                json = JSON.parse(text);
            } catch (err) {
                return text
            }
            if (json.code != undefined && json.code != 0) {
                if (json?.code == 500 && (json?.msg?.includes?.('Êú™ÁôªÂΩï') || json?.data?.includes?.('Êú™ÁôªÂΩï'))) {
                    loginState.value = false
                }
                throw new Error(json.msg || json.data || i18n('ÊúçÂä°Âô®ÈîôËØØ!'));
            }
            return json.data ?? json;
        }).catch(function (error) {
            if (error.message == 'signal is aborted without reason') {
                // ÂèñÊ∂àËØ∑Ê±Ç‰∏≠Êñ≠ÁöÑÈîôËØØÊó•Âøó
                throw new Error(i18n('ËØ∑Ê±Ç‰∏≠Êñ≠'));
            }
            if (showNotLoginLog || !error?.message?.includes('Êú™ÁôªÂΩï')) {
                showLog((msg || 'ËØ∑Ê±ÇÂ§±Ë¥•!'), error);
            }
            if (typeof errorCallback == 'function') errorCallback(error);
            else {
                ElMessage.error((msg || i18n('ËØ∑Ê±ÇÂ§±Ë¥•!')) + ' ' + error.message);
                throw error;
            }
        }).finally((res) => requesting[msg] = false);
    }

    const generateData = (columns, length = 200, prefix = 'row-') =>
        Array.from({ length }).map((_, rowIndex) => {
            return columns.reduce(
                (rowData, column, columnIndex) => {
                    rowData[column.dataKey] = `Row ${rowIndex} - Col ${columnIndex}`
                    return rowData
                },
                {
                    id: `${prefix}${rowIndex}`,
                    parentId: null,
                }
            )
        });

    function genMsg(length, fix) {
        return Array.from({ length }).map((_, rowIndex) => ({
            id: rowIndex,
            content: fix + ' Message ' + rowIndex,
            userId: rowIndex % 2 == 0 ? rowIndex : fix
        }))
    }

    var pyodide, puasePyodide;
    /**
     * ËøêË°åpython‰ª£Á†Å
     */
    async function runPythonCode(code, pyPackages) {
        if (puasePyodide) return ElMessage.warning(i18n('ËØ∑Á®çÁ≠â') + '...' + puasePyodide);
        if (typeof pyodide != 'object' && typeof loadPyodide != 'function') {
            puasePyodide = i18n('Ê≠£Âú®Âä†ËΩΩPython‰ª£Á†ÅËøêË°åÁéØÂ¢É‰∏≠')
            ElMessage.warning(puasePyodide);
            try {
                // Âä†ËΩΩ pyodide
                await (new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/pyodide/v0.27.5/full/pyodide.js';
                    script.onload = resolve;
                    script.onerror = () => {
                        reject(new Error(i18n('Âä†ËΩΩPython‰ª£Á†ÅËøêË°åÁéØÂ¢ÉÂ§±Ë¥•')));
                    }
                    document.head.appendChild(script);
                }));
                pyodide = await loadPyodide();
                ElMessage.success(i18n('Python‰ª£Á†ÅËøêË°åÁéØÂ¢ÉÂä†ËΩΩÊàêÂäü'));
            } catch (error) {
                console.error(error);
                ElMessage.error(error.message);
                return error;
            }
            puasePyodide = null;
            if (typeof pyodide != 'object') return;
        }
        if (Array.isArray(pyPackages)) {
            for (const pkg of pyPackages) {
                ElMessage.info(i18n('Ê≠£Âú®Âä†ËΩΩpythonÊ®°Âùó') + ': ' + pkg);
                await pyodide.loadPackage(pkg);
            }
        }
        return await pyodide.runPythonAsync(code);
    }

    /**
     * ËøêË°åpy‰ª£Á†ÅÔºåÁ¨¨‰∏ÄË°å‰∏∫Ê≥®ÈáäÁöÑjs‰ª£Á†ÅÔºå‰æãÂ¶Ç
     * ```py
     * # ['numpy','pandas','scipy']
     * import sys
     * sys.version
     * ```
     */
    async function pyEval(code) {
        let pkgs = code.split('\n').shift();
        // Ê∏ÖÈô§‰∏§ËæπÁöÑÁ©∫ÁôΩÂ≠óÁ¨¶‰∏éÂâçÈù¢ÁöÑÊ≥®ÈáäÁ¨¶Âè∑#
        try {
            pkgs = eval(`(${cleanCommentLine(pkgs)})`);
        } catch (error) {
            showLog(i18n('Ê≤°ÊúâÂØºÂåÖÊàñËß£ÊûêÂ§±Ë¥•'), error);
            pkgs = [];
        }
        return await runPythonCode(code, pkgs)
    }
    /**
     * Ê∏ÖÈô§Â≠óÁ¨¶‰∏≤ÂâçÂêéÁ©∫ÁôΩÔºå‰∏îÂøÖÈ°ªÂåπÈÖç#Ê≥®ÈáäÂºÄÂ§¥ÔºåÂ¶ÇÊûúÊ≤°Êúâ#ÂºÄÂ§¥ÔºåÂàôËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤
     * @param {string} str - ËæìÂÖ•Â≠óÁ¨¶‰∏≤ÔºàÂ¶Ç "# ['numpy']  "Ôºâ
     * @returns {string} - Â§ÑÁêÜÂêéÁöÑÂ≠óÁ¨¶‰∏≤ÔºàÂ¶Ç "['numpy']"Ôºâ 
     */
    function cleanCommentLine(str) {
        let re = str.trim();
        if (re.startsWith('#')) {
            while (re.startsWith('#')) re = re.substring(1);
            re = re.trim();
            return re;
        } else return '';   // Â¶ÇÊûúÊ≤°Êúâ#ÂºÄÂ§¥ÔºåÂàôËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤
    }

    /**
     * ‰ΩøÁî® marked Ëß£Êûê Markdown
     */
    function parseMarked(str) {
        return marked.parse(str);
    }

    /**
     * Html‰ΩøÁî®
     * Âä†ÂØÜÂ≠óÁ¨¶‰∏≤
     * @param {string} text Ë¶ÅÂä†ÂØÜÁöÑÊòéÊñá
     * @returns {string} Âä†ÂØÜÂêéÁöÑÂ≠óÁ¨¶‰∏≤Base64Ê†ºÂºè
     */
    function encryptToBase64(text) {
        const KEY = '9a8b7c6d5e412f3a2b1c0d9e8f7a6b5c';
        const IV = CryptoJS.enc.Hex.parse('9a8b7c6d5e4f3a2b1caa0d9e8f7a6b5c');
        const encrypted = CryptoJS.AES.encrypt(text, CryptoJS.enc.Utf8.parse(KEY), {
            iv: IV,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        });
        return encrypted.toString();
    }

    createApp({
        data() {
            return {
                previewTopicList: [],
                xxHasher: null,
                uploadedFiles: [],
                fileName: '',
                files: [],
                filesHashCache: {

                },
                selectFileNameTimerId: '',
                currentTime: 0,
                currentTimeId: null,
                currentRows: 1,
                currentRowsFull: 5,
                nothidePage: {
                    left: true,
                    right: true,
                    bottom: true,
                },
                startNumber: 0,
                leftWidth: null,
                version: i18n('ÁâàÊú¨') + `1.2
Â¢ûÂä†ÁÆ°ÁÆ°ÁêÜÁî®Êà∑ÁöÑÂäüËÉΩ‰∏éÂÖ∂‰ªñ‰ºòÂåñ
1.1
ÊîØÊåÅÊñá‰ª∂‰∏ä‰º†Ôºå‰ΩÜÊòØÊñá‰ª∂‰∏ä‰º†‰∏çËÉΩ‰ΩøÁî®Ëá™ÂÆö‰πâÊñá‰ª∂ÂêçÔºåÂ¶ÇÊûúÊÉ≥Ë¶Å‰ΩøÁî®Ëá™ÂÆö‰πâÊñá‰ª∂ÂêçËØ∑ÊâãÂä®Êìç‰ΩúÊ∑ªÂä† ?dfn=Êñ∞ÂêçÂ≠ó ÂèÇÊï∞Âà∞‰∏ãËΩΩËØ∑Ê±Ç‰∏≠`,
                rightPage: {
                    now: RightPageMap.welcome,
                    map: RightPageMap,
                    def: RightPageMap.welcome
                },
                hoveredRow: null,
                isShowFriendList: false,
                loginState: loginState,
                // ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
                user: {
                    username: '',
                    userId: -1,
                    avatar: 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png',
                    // Â¶ÇÊûúÊÉ≥Ë¶ÅÊòæÁ§∫Â§¥ÂÉèÔºåÈúÄË¶ÅÁî®axiosËØ∑Ê±ÇÂà∞ÂõæÁâáÁÑ∂ÂêéËΩ¨Êàêbase64ÊîæÂà∞Ëøô‰∏™Âú∞ÊñπÔºåÂê¶ÂàôÊòæÁ§∫ÂêçÂ≠ó
                    showAvatar: '',
                    superAdmin: false,
                    isAdmin: false,
                },
                editUser: {
                    username: '',
                    userId: -1,
                    avatar: 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png',
                    // Â¶ÇÊûúÊÉ≥Ë¶ÅÊòæÁ§∫Â§¥ÂÉèÔºåÈúÄË¶ÅÁî®axiosËØ∑Ê±ÇÂà∞ÂõæÁâáÁÑ∂ÂêéËΩ¨Êàêbase64ÊîæÂà∞Ëøô‰∏™Âú∞ÊñπÔºåÂê¶ÂàôÊòæÁ§∫ÂêçÂ≠ó
                    showAvatar: '',
                    password: '',
                    password2: '',
                    oldPassword: '',
                },
                // Êü•ÁúãÁöÑÁî®Êà∑‰ø°ÊÅØ
                showUser: null,
                login: {
                    loginPageVisible: false,
                    register: false,
                    form: {
                        username: '',
                        password: '',
                        password2: ''
                    },
                },
                inmsg: '',
                searchQuery: '',
                leftWidth: 0,
                tableWidth: 350,
                tableHeight: 569,
                onlineSelect: [],
                onlineListData: [],
                showOnlineListData: [],
                msgsSelect: [],
                msgsListData: [],
                showMsgsListData: [],
                columns: [{
                    key: 'column-1',
                    dataKey: 'column-1',
                    title: '',
                }],
                selectTopic: topicType,
                selectTopicId: null,
                fetchTimeStep: 5000,
                monitorTopicFetchController: null,
                monitorTopicFetchTime: 0,
                lastMonitorTopicFetchTag: null,
                monitorGetMsgsListFetchController: null,
                monitorGetMsgsListFetchTime: 0,
                monitorGetOnlineListFetchController: null,
                monitorGetOnlineListFetchTime: 0,
                messages: [],
                messagesPlus: {
                    'Ê∂àÊÅØid': {
                        ÂÖ∂‰ªñÊìç‰Ωú: false,
                        view: 'origin Ê∫êÁ†Å(ÈªòËÆ§)' || 'render Ê∏≤Êüì'
                    }
                },
                msgs: {},
                msgTemplate: {
                    type: 'js',
                    typeList: Object.keys(runMsgMap).map((item) => ({
                        label: item,
                        value: item
                    })),
                },
                editMsgId: null,
                settingsButs: [
                    {
                        title: (msg) => i18n('ÂÖ≥‰∫é'),
                        click: (msg) => this.onAbout(),
                    },
                    {
                        title: (msg) => i18n('ÂàõÂª∫ËØùÈ¢ò'),
                        click: (msg) => this.createTopic(),
                    },
                    {
                        title: (msg) => i18n('Ê∏ÖÁêÜÁºìÂ≠ò'),
                        click: (msg) => this.onClearCache(),
                    },
                    {
                        title: (msg) => i18n('Êú™ÂëΩ‰∏≠ÁöÑÂõΩÈôÖÂåñÂ≠óÊÆµÊï∞Èáè') + `(${Object.keys(TextMap.__notFound).length})`,
                        click: (msg) => this.showNotFoundText(),
                    },
                    {
                        title: (msg) => i18n('‰øùÂ≠òÊï∞ÊçÆÂ∫ì'),
                        click: (msg) => this.onSaveDB(),
                    },
                ],
                msgButsUser: [
                    // {
                    //     style: 'color:red;',
                    //     title: (msg) => i18n('Áî®Êà∑Âêç'),
                    //     visible: (msg) => true,
                    //     getBody: (msg) => 'ÊòæÁ§∫ÂÜÖÂÆπ',
                    //     click: (msg) => this.copyContent(msg.content),
                    // },
                    {
                        title: (msg) => i18n('Áî®Êà∑Âêç') + msg.username,
                        click: (msg) => this.showUserInfoPageByUserId(msg.userId),
                        getBody: (msg) => msg.username,
                    },
                    {
                        title: (msg) => i18n('Á±ªÂûã') + ': ' + msg.type,
                        click: (msg) => this.runMsg(msg),
                        getBody: (msg) => 't: ' + msg.type,
                    },
                    {
                        title: (msg) => i18n('È¢ÑËßà') + ': ' + msg.type,
                        click: (msg) => {
                            if (typeof this.messagesPlus[msg.id] != 'object') this.messagesPlus[msg.id] = {};
                            this.messagesPlus[msg.id].view = (this.messagesPlus[msg.id].view == 'render' ? 'origin' : 'render');
                        },
                        getBody: (msg) => (this?.messagesPlus?.[msg.id]?.view == 'render' ? i18n('ÂÖ≥Èó≠È¢ÑËßà') : i18n('È¢ÑËßà')),
                    },
                    {
                        title: (msg) => `${i18n('Ê∂àÊÅØÊó∂Èó¥')}: ${new Date(msg.time).toLocaleString()}\n${i18n('Êõ¥Êñ∞Êó∂Èó¥')}: ${(0 < msg.updateTime ? new Date(msg.updateTime).toLocaleString() : '-')}`,
                        click: (msg) => this.showText(`${i18n('Ê∂àÊÅØÊó∂Èó¥')}: ${new Date(msg.time).toLocaleString()}\n${i18n('Êõ¥Êñ∞Êó∂Èó¥')}: ${(
                            0 < msg.updateTime ? new Date(msg.updateTime).toLocaleString() : '-')}`.replaceAll('\n', '<br>'), i18n('Ê∂àÊÅØÊó∂Èó¥')),
                        getBody: (msg) => new Date(msg.time).toLocaleTimeString(),
                    },
                    {
                        title: (msg) => i18n('Â§çÂà∂'),
                        click: (msg) => this.copyContent(msg.content),
                    },
                ],
                msgButsMe: [
                    // {
                    //     title: (msg) => i18n('Áî®Êà∑Âêç'),
                    //     visible: (msg) => true,
                    //     getBody: (msg) => 'ÊòæÁ§∫ÂÜÖÂÆπ',
                    //     click: (msg) => this.copyContent(msg.content),
                    // },
                    {
                        title: (msg) => i18n('Â§çÂà∂'),
                        click: (msg) => this.copyContent(msg.content),
                    },
                    {
                        title: (msg) => i18n('Âà†Èô§'),
                        click: (msg) => this.deleteMsg(msg),
                    },
                    {
                        title: (msg) => i18n('ÁºñËæë'),
                        click: (msg) => this.editMsgId = msg.id,
                        visible: (msg) => msg.id != this.editMsgId,
                    },
                    {
                        title: (msg) => i18n('ÂèñÊ∂àÁºñËæë'),
                        click: (msg) => this.editMsgId = null,
                        visible: (msg) => msg.id == this.editMsgId,
                    },
                    {
                        title: (msg) => i18n('Êõ¥Êñ∞'),
                        click: (msg) => this.updateMsg(msg),
                        visible: (msg) => msg.id == this.editMsgId,
                    },
                    {
                        title: (msg) => i18n('Á±ªÂûã') + ': ' + msg.type,
                        click: (msg) => this.runMsg(msg),
                        getBody: (msg) => 't: ' + msg.type,
                    },
                    {
                        title: (msg) => i18n('È¢ÑËßà') + ': ' + msg.type,
                        click: (msg) => {
                            if (typeof this.messagesPlus[msg.id] != 'object') this.messagesPlus[msg.id] = {};
                            this.messagesPlus[msg.id].view = (this.messagesPlus[msg.id].view == 'render' ? 'origin' : 'render');
                        },
                        getBody: (msg) => (this?.messagesPlus?.[msg.id]?.view == 'render' ? i18n('ÂÖ≥Èó≠È¢ÑËßà') : i18n('È¢ÑËßà')),
                    },
                    {
                        title: (msg) => `${i18n('Ê∂àÊÅØÊó∂Èó¥')}: ${new Date(msg.time).toLocaleString()}\n${i18n('Êõ¥Êñ∞Êó∂Èó¥')}: ${(0 < msg.updateTime ? new Date(msg.updateTime).toLocaleString() : '-')}`,
                        click: (msg) => this.showText(`${i18n('Ê∂àÊÅØÊó∂Èó¥')}: ${new Date(msg.time).toLocaleString()}\n${i18n('Êõ¥Êñ∞Êó∂Èó¥')}: ${(
                            0 < msg.updateTime ? new Date(msg.updateTime).toLocaleString() : '-')}`.replaceAll('\n', '<br>'), i18n('Ê∂àÊÅØÊó∂Èó¥')),
                        getBody: (msg) => new Date(msg.time).toLocaleTimeString(),
                    },
                    {
                        title: (msg) => i18n('Áî®Êà∑Âêç') + msg.username,
                        click: (msg) => this.showUserInfoPageByUserId(msg.userId),
                        getBody: (msg) => msg.username,
                    },
                ],
                originData: '',
                cryptoData: '',
                cryptoKey: '',
                refreshMsgsTag: false,
                intes: {
                    global: null,
                    m_getMsg: null,
                    m_onlineList: null,
                    m_topicList: null
                },
                editor: null,
                lineHeight: 20,
                padding: 10, // ‰∏ä‰∏ãÂêÑ5px
                editorHeight: 30, // ÂàùÂßãÈ´òÂ∫¶ (1Ë°å)
                adjustEditorHeightTimeout: null,
                editorStatus: false,
                useEditor: false,
                avatarImageCache: [],
                fristLoadUserInfo: true,
                editTopic: {
                },
            }
        },
        computed: {
            activeMessage() {
                return this.messages[this.activeIndex];
            },
            // ÁîüÊàêÂÖ®Â±èÈ¢ÑËßàÁöÑÂõæÁâáURLÂàóË°®
            previewList() {
                return this.uploadedFiles.map(file => this.fileUrl(file));
            },
        },
        mounted() {
            this.readUserInfo();
            this.handleSwitchChange('monitor');
            this.updateTableSize();
            window.addEventListener('resize', this.updateTableSize);
            this.currentTimeId = setInterval(() => this.currentTime = Date.now(), 100);
            this.intes.global = setInterval(this.globalInte, 2000);
        },
        beforeUnmount() {
            window.removeEventListener('resize', this.updateTableSize);
            clearInterval(this.currentTimeId);
        },
        beforeDestroy() {
            if (monacoEditor) {
                monacoEditor.dispose();
            }
        },
        watch: {
            currentRows(newVal, oldVal) {
                this.adjustEditorHeight()
            },
            'msgTemplate.type'(newVal, oldVal) {
                this.upModelLanguage()
            },
            useEditor(newVal, oldVal) {
                if (newVal) {
                    this.writeText(this.inmsg)
                } else {
                    this.readText()
                }
            },
        },
        methods: {
            i18n: i18n,
            /**
             * @params {string} pageName È°µÈù¢ÂêçÔºåÂèØÈÄâÈ°π {
                        msgs: 'msgs',
                        welcome: 'welcome',
                        showUser: 'showUser',
                    }
             * @return {string|undefined} Ê≠£Âú®‰ΩøÁî®ÁöÑkey
             */
            selectRightPage(pageName) {
                let usePageName;
                this.rightPage.now = this.rightPage.map[pageName] || this.rightPage.def;
                for (const pn in this.rightPage.map) {
                    const val = this.rightPage.map[pn];
                    if (val == this.rightPage.now) {
                        usePageName = pn;
                        break;
                    }
                }
                if (usePageName != pageName) console.warn('The page you are using does not exist.', pageName);
                return usePageName;
            },
            handleOnlineSelect(userId) {
                this.selectRightPage(RightPageMap.showUser);
                this.readUserInfo(userId);
            },
            handleRefreshMsgs() {
                this.refreshMsgsTag = !this.refreshMsgsTag;
                const topic = this.showMsgsListData.find(msgs => msgs.topicId == this.selectTopicId)
                this.handleMsgsSelect(topic, true);
            },
            handleMsgsSelect(topic, refresh) {
                let topicId = topic.topicId;
                this.selectRightPage(RightPageMap.msgs);
                if (!refresh && this.selectTopicId == topicId) return;
                this.selectTopic = topic;
                this.selectTopicId = topicId;
                this.readMsgList();
                this.getMsg(false, 'monitorAddMsg');
                this.scrollToBottom(null, 100);
                this.checkRows();
                this.initMonacoEditor();
            },
            readMsgList() {
                // ËØ∑Ê±ÇÊ∂àÊÅØÊï∞ÊçÆ
                if (!Array.isArray(this.msgs[this.selectTopicId])) this.msgs[this.selectTopicId] = [];
                this.messages = [...this.msgs[this.selectTopicId]];
                this.updateTableSize();
                // ËØªÂèñÊâÄÊúâÁöÑ ÂõæÁâáÊ∂àÊÅØËøõË°åÊî∂ÈõÜ
                this.previewTopicList = this.messages.filter(msg => msg.type == 'image').map(msg => {
                    return this.fileUrl(msg.content)
                });

                // Ê∑ªÂä†ÊâÄÊúâÊ∂àÊÅØÂà∞Ê∂àÊÅØÈÖçÁΩÆ‰∏≠
                const mp = this.messagesPlus = {};
                this.messages.forEach(msg => this.messagesPlus[msg.id] = {});
                // ÂõæÁâáÂíåjsÈªòËÆ§ÂºÄÂêØÈ¢ÑËßà
                this.messages.filter(msg => {
                    return msg.type == 'image'
                }).map(msg => {
                    mp[msg.id].view = 'render';
                });
            },
            handleSearchInput() {
                clearTimeout(this.searchTimeout); // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
                this.searchTimeout = setTimeout(() => {
                    this.handleSwitchChange()
                }, 100); // ËÆæÁΩÆ 100ms ÁöÑÂª∂Ëøü
            },
            /**
             * Âà∑Êñ∞Â∑¶‰æßÂàóË°®Êï∞ÊçÆ
             * ÊØèÊ¨°ÂàáÊç¢Êó∂Âª∂Ëøü100msÂà∑Êñ∞ÔºåËøôÊ†∑ÂèØ‰ª•ÈÅøÂÖçËøûÁª≠ÂàáÊç¢ÂØºËá¥ËøûÁª≠Âà∑Êñ∞
             * Â¶ÇÊûúÊòØÊâãÂä®ÁöÑËØùÂ∞±ÂÖàËøêË°å‰∏ÄÊ¨°
             */
            handleSwitchChange(monitor) {
                if (this.isShowFriendList) {
                    if (monitor == 'manual') this.getOnlineList(100);
                    monitor ? this.monitorGetOnlineList(monitor) : this.getOnlineList(100);
                } else {
                    if (monitor == 'manual') this.getMsgsList(100);
                    monitor ? this.monitorGetMsgsList(monitor) : this.getMsgsList(100);
                }
            },
            getMsgsList(delay) {
                this.sortShowMsgsListData();
                clearTimeout(this.getOnlineListTimeout); // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
                this.getOnlineListTimeout = setTimeout(() => {
                    warpFetch(() => fetch(API_PREFIX + '/msg/topicList'), 'Ëé∑ÂèñÊ∂àÊÅØÂàóË°®', () => { }).then(data => {
                        this.msgsListData.splice(0, this.msgsListData.length, ...data);
                        this.sortShowMsgsListData();
                    });
                }, 0 < Number(delay) ? Number(delay) : 2000); // ËÆæÁΩÆ 2000ms ÁöÑÂª∂Ëøü
            },
            async monitorGetMsgsList(monitor, InterruptMsg) {
                // Â¶ÇÊûúÊúâÊ≠£Âú®ËøõË°å‰∏≠ÁöÑËØ∑Ê±ÇÂ∞±ÂèñÊ∂àÊéâ
                if (this.monitorGetMsgsListFetchController) {
                    if (Date.now() < this.monitorGetMsgsListFetchTime) return;
                    if (InterruptMsg) console.info('monitorGetMsgsList', i18n('ÊâìÊñ≠‰ø°ÊÅØ'), InterruptMsg)
                    this.monitorGetMsgsListFetchController.abort();
                }

                if (this?.user?.userId == null) return showLog('Êú™ÁôªÂΩï');
                this.intes.m_topicList = Date.now();
                warpFetch(() => {
                    // ÂàõÂª∫Êñ∞ÁöÑËØ∑Ê±Ç
                    const controller = new AbortController();
                    this.monitorGetMsgsListFetchController = controller;
                    this.monitorGetMsgsListFetchTime = Date.now() + this.fetchTimeStep;
                    return fetch(API_PREFIX + '/msg/m_topicList', { signal: controller.signal })
                }, 'ÁõëÊéßÊ∂àÊÅØÂàóË°®', () => { }).then(data => {
                    if (data == undefined) { return; }
                    this.msgsListData.splice(0, this.msgsListData.length, ...data);
                    this.sortShowMsgsListData();
                }).finally(res => {
                    this.intes.m_topicList = null;
                    this.monitorGetMsgsList(monitor);
                });
            },
            getOnlineList(delay) {
                this.sortShowOnlineListData();
                clearTimeout(this.getOnlineListTimeout); // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
                this.getOnlineListTimeout = setTimeout(() => {
                    warpFetch(() => fetch(API_PREFIX + '/user/onlineList'), 'Ëé∑ÂèñÂú®Á∫øÁî®Êà∑ÂàóË°®', () => { }).then(data => {
                        this.onlineListData.splice(0, this.onlineListData.length, ...data);
                        this.completeAvatarImage(this.onlineListData);
                        this.sortShowOnlineListData();
                    });
                }, 0 < Number(delay) ? Number(delay) : 2000); // ËÆæÁΩÆ 2000ms ÁöÑÂª∂Ëøü
            },
            async monitorGetOnlineList(monitor, InterruptMsg) {
                // Â¶ÇÊûúÊúâÊ≠£Âú®ËøõË°å‰∏≠ÁöÑËØ∑Ê±ÇÂ∞±ÂèñÊ∂àÊéâ
                if (this.monitorGetOnlineListFetchController) {
                    if (Date.now() < this.monitorGetOnlineListFetchTime) return;
                    if (InterruptMsg) console.info('monitorGetOnlineList', i18n('ÊâìÊñ≠‰ø°ÊÅØ'), InterruptMsg)
                    this.monitorGetOnlineListFetchController.abort();
                }

                if (this?.user?.userId == null) return showLog('Êú™ÁôªÂΩï');
                this.intes.m_onlineList = Date.now();
                warpFetch(() => {
                    // ÂàõÂª∫Êñ∞ÁöÑËØ∑Ê±Ç
                    const controller = new AbortController();
                    this.monitorGetOnlineListFetchController = controller;
                    this.monitorGetOnlineListFetchTime = Date.now() + this.fetchTimeStep;
                    return fetch(API_PREFIX + '/user/m_onlineList', { signal: controller.signal })
                }, 'ÁõëÊéßÂú®Á∫øÁî®Êà∑ÂàóË°®', () => { }).then(data => {
                    if (data == undefined) { return; }
                    this.onlineListData.splice(0, this.onlineListData.length, ...data);

                    this.sortShowOnlineListData();
                }).finally(res => {
                    this.intes.m_onlineList = null;
                    this.monitorGetOnlineList(monitor);
                });
            },
            scrollToBottom(num, time) {
                if (0 < time) time = time < 2000 ? time : 500;
                else time = 500;
                setTimeout(() => {
                    const tableE = this.$refs.tableRef.$el.querySelector('.el-table__body');
                    // ÊªöÂä®Âà∞Â∫ïÈÉ®ÔºåÊªöÂä®Âà∞È°∂ÈÉ®ÁöÑËØùÁªôÂÄº 0 Âç≥ÂèØ
                    this.$refs.tableRef.setScrollTop(tableE.scrollHeight)
                }, time);
            },
            // ËôöÊãüË°®Ê†ºÁöÑÊó∂ÂÄôÁî®ÁöÑ
            scrollToBottom_bak(num, time) {
                if (0 < time) time = time < 2000 ? time : 500;
                else time = 500;
                setTimeout(() => {
                    this.$refs.tableRef.scrollToRow(num ?? this.messages.length - 1)
                }, time);
            },
            sortShowMsgsListData() {
                // ÊéíÂ∫è‰∏éÊêúÁ¥¢
                this.showMsgsListData = this.msgsListData.filter(item => {
                    if (0 < this.searchQuery.length) {
                        return item.name.toLowerCase().includes(this.searchQuery.toLowerCase())
                    }
                    return true
                }).sort((a, b) => b?.lastMsg?.time - a?.lastMsg?.time);
            },
            sortShowOnlineListData() {
                // ÊéíÂ∫è‰∏éÊêúÁ¥¢
                this.showOnlineListData = this.onlineListData.filter(item => {
                    if (0 < this.searchQuery.length) {
                        return item.username.toLowerCase().includes(this.searchQuery.toLowerCase())
                    }
                    return true
                }).sort((a, b) => {
                    // Ëøô‰∏™Êï∞ÁªÑ‰∏≠ÔºåÂ¶ÇÊûúÊòØÂΩìÂâçÁôªÂΩïÁöÑÁî®Êà∑ÈÇ£‰πàÊéíÂà∞Á¨¨‰∏Ä‰ΩçÔºåÂÖ∂‰ªñÁöÑÊåâÁÖßÂú®Á∫øÊó∂Èó¥
                    if (a.userId === this.user.userId) return -1;
                    if (b.userId === this.user.userId) return 1;
                    return b.lastUpdateTime - a.lastUpdateTime;
                });
            },
            sortInsertToTop(topicId) {
                let index = this.showOnlineListData.findIndex(online => online.topicId == topicId);
                let online = this.showOnlineListData[index];
                if (online) {
                    this.showOnlineListData.splice(index, 1);
                    this.showOnlineListData.unshift(online);
                } else {
                    showLog('Ê≤°ÊúâÊâæÂà∞Ê∂àÊÅØÂØπË±°')
                }
            },
            sendMsgToServer() {
                let lmsg = this.inmsg;
                if (this.useEditor) {
                    lmsg = this.readText();
                }
                this.writeText('');
                if (lmsg != '') {
                    this.sendMsg(lmsg, 0);
                }
            },
            deleteMsg(msg) {
                warpFetch(() => fetch(API_PREFIX + '/msg/delMsg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...msg,
                        topicId: this.selectTopicId
                    })
                }), 'Âà†Èô§Ê∂àÊÅØ').then(data => {
                    let i = this.msgs[this.selectTopicId].findIndex(m => m.id == msg.id);
                    this.msgs[this.selectTopicId].splice(i, 1);
                    i = this.messages.findIndex(m => m.id == msg.id);
                    this.messages.splice(i, 1);
                });
            },
            updateMsg(msg) {
                warpFetch(() => fetch(API_PREFIX + '/msg/updateMsg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...msg,
                        topicId: this.selectTopicId
                    })
                }), 'Âà†Èô§Ê∂àÊÅØ').then(data => {
                    ElMessage.success('Ê∂àÊÅØÂ∑≤ÁºñËæë');
                    this.editMsgId = null;
                });
            },
            sendMsg(msg, retry, sendSuccess) {
                if (retry == undefined) retry = 0;
                const dn = Date.now();
                /* ÂΩìÂâçÁöÑÊ∂àÊÅØÂàóË°® */
                const msgs = this.messages;

                if (typeof msg == 'string') msg = {
                    topicId: this.selectTopicId,// Ê∂àÊÅØIDÔºå‰πüÂ∞±ÊòØÊñá‰ª∂ÂêçÂ≠ó
                    userId: this.user.userId,   // ÂΩìÂâçÁî®Êà∑idÔºåÁî®‰∫éÊ£ÄÈ™åÊòØÂê¶ÊúâÊùÉÈôê
                    sendTime: Date.now(),       // ÂèëÈÄÅÊó∂Èó¥
                    // time: dn,                // ÊúçÂä°Âô®Êî∂Âà∞ÁöÑÊó∂Èó¥
                    senderror: false,           // ÂèëÈÄÅÂ§±Ë¥•ÔºåÂ¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•Âàô‰ºöÂèòÊàêÈîôËØØ‰ø°ÊÅØ
                    content: msg,               // Ê∂àÊÅØ
                    type: this.msgTemplate.type || 'txt'
                };
                if (typeof msg != 'object') return console.error('Ê∂àÊÅØÁ±ªÂûãÂºÇÂ∏∏ÔºåÂèëÈÄÅÂ§±Ë¥•'), alert('ÂèëÈÄÅÂ§±Ë¥•' + typeof msg);
                if (!msg.topicId) msg.topicId = Date.now();

                if (retry == 0) {
                    msgs.push(msg);
                    this.scrollToBottom();  // ÊªëÂà∞ÊúÄÂ∫ïÈÉ®
                    this.sortInsertToTop(this.selectTopicId); // ÊéíÂ∫èÊ∂àÊÅØ
                };
                warpFetch(() => fetch(API_PREFIX + '/msg/addMsg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(msg)
                }), 'ÂèëÈÄÅÊ∂àÊÅØ', (error) => {
                    if (typeof retry == 'number' && 0 < retry) retry = 0;
                    if (5 < retry) {
                        msg.senderror = error;
                        return;
                    }
                    // ÂèëÈÄÅÂ§±Ë¥•ÔºåÈáçÊñ∞ÂèëÈÄÅ
                    setTimeout(() => {
                        this.sendMsg(msg, retry + 1)
                    }, (1000 * retry) + 1000)
                }).then(data => {
                    if (typeof data == 'object' && data.time) {
                        console.log('Ê∂àÊÅØÂèëÈÄÅÊàêÂäü', data);
                        let i = msgs.indexOf(msg);
                        if (-1 < i) msgs.splice(i, 1);
                        if (typeof sendSuccess == 'function') sendSuccess(data);
                    }
                });
            },
            async monitorAddMsg(InterruptMsg) {
                // Â¶ÇÊûúÊúâÊ≠£Âú®ËøõË°å‰∏≠ÁöÑËØ∑Ê±ÇÂ∞±ÂèñÊ∂àÊéâ
                if (this.monitorTopicFetchController) {
                    if (Date.now() < this.monitorTopicFetchTime) return;
                    if (InterruptMsg) console.info('monitorAddMsg', i18n('ÊâìÊñ≠‰ø°ÊÅØ'), InterruptMsg)
                    this.monitorTopicFetchController.abort();
                }
                const topicId = this.selectTopicId;
                const msgs = this.msgs[this.selectTopicId];

                if (this?.user?.userId == null) return showLog('Êú™ÁôªÂΩï');
                if (topicId == null) return showLog('topicIdÂèÇÊï∞‰∏çÂ≠òÂú®');
                if (topicId == this.lastMonitorTopicFetchTag) return showLog('topicIdË¢´‰∏¥Êó∂Ê†áËÆ∞‰∏∫Â§±Êïà');
                this.lastMonitorTopicFetchTag = null;   // Ê∏ÖÁêÜËÆ∞ÂΩï
                this.intes.m_getMsg = Date.now();
                warpFetch(() => {
                    // ÂàõÂª∫Êñ∞ÁöÑËØ∑Ê±Ç
                    const controller = new AbortController();
                    this.monitorTopicFetchController = controller;
                    this.monitorTopicFetchTime = Date.now() + this.fetchTimeStep;
                    return fetch(API_PREFIX + '/msg/m_getMsg', {
                        signal: controller.signal,
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            topicId,  // Ê∂àÊÅØIDÔºå‰πüÂ∞±ÊòØÊñá‰ª∂ÂêçÂ≠ó
                            endMsg: Array.isArray(msgs) ? msgs[msgs.length - 1] : null, // Áî®‰∫éÊà™ÂèñÊúÄÂêéÁöÑÊ∂àÊÅØÔºåËøôÊ†∑‰∏ãËΩΩÂà∞ÁöÑÊï∞ÊçÆÂèØ‰ª•Áõ¥Êé•ËøΩÂä†Âà∞ÂàóË°®‰∏≠
                        })
                    })
                }, 'ÁõëÂê¨ÊúÄÊñ∞Ê∂àÊÅØ' + this.selectTopicId, (error) => {
                    if (error.message == 'Êó†ÊùÉÈôêÊìç‰Ωú!') {
                        // ËÆ∞ÂΩïÂ§±ÊïàÁöÑËØùÈ¢òidÔºåÂàáÊç¢Âç≥ÂèØÊÅ¢Â§ç
                        this.lastMonitorTopicFetchTag = topicId;
                    }
                }).then(data => {
                    if (data == undefined) { return; }
                    if (Array.isArray(data)) {
                        data.forEach(msg => {
                            msgs.push(msg);
                            this.messages.push(msg);
                        });
                        // ÊªëÂà∞ÊúÄÂ∫ïÈÉ®
                        this.scrollToBottom();
                    }
                }).finally(res => {
                    this.intes.m_getMsg = null;
                    this.monitorAddMsg();
                })

            },
            /**
             * @param {boolean} back ÊòØÂê¶ÂæÄ‰∏äÁøªËÅäÂ§©ËÆ∞ÂΩï
             * ÈªòËÆ§Âè™‰ºöÂæÄ‰∏ãËØ∑Ê±ÇÊ∂àÊÅØ
             * Â¶ÇÊûú‰º†ÈÄí‰∫ÜËøô‰∏™ÂèÇÊï∞ÂàôÂæÄ‰∏äËØ∑Ê±Ç
             * Â¶ÇÊûúÊ∂àÊÅØ‰∏∫Á©∫ÔºåÈÇ£‰πà‰ºöÊãâÂèñÊúÄÊñ∞ÁöÑÊ∂àÊÅØ
             * ÊØèÊ¨°ËØ∑Ê±ÇÊ∂àÊÅØÊï∞Èáè‰∏äÈôê‰∏∫30Êù°
             */
            getMsg(back, monitorAddMsg) {
                back = !!back;
                const topicId = this.selectTopicId;
                const userId = this.user.userId;
                const msgs = this.msgs[this.selectTopicId];
                // ËØ∑Ê±ÇÊ∂àÊÅØÊï∞ÊçÆ
                // if (!Array.isArray(this.msgs[this.selectTopicId])) this.msgs[this.selectTopicId] = [];
                // this.messages = [...this.msgs[this.selectTopicId]];

                warpFetch(() => fetch(API_PREFIX + '/msg/getMsg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        topicId,  // Ê∂àÊÅØIDÔºå‰πüÂ∞±ÊòØÊñá‰ª∂ÂêçÂ≠ó
                        userId, // ÂΩìÂâçÁî®Êà∑idÔºåÁî®‰∫éÊ£ÄÈ™åÊòØÂê¶ÊúâÊùÉÈôê
                        endMsg: back ? msgs[0] : msgs[msgs.length - 1], // Áî®‰∫éÊà™ÂèñÊúÄÂêéÁöÑÊ∂àÊÅØÔºåËøôÊ†∑‰∏ãËΩΩÂà∞ÁöÑÊï∞ÊçÆÂèØ‰ª•Áõ¥Êé•ËøΩÂä†Âà∞ÂàóË°®‰∏≠
                        back,
                        limit: 30,
                    })
                }), 'Ëé∑ÂèñÊúÄÊñ∞Ê∂àÊÅØ' + this.selectTopicId).then(data => {
                    if (data) {
                        let keys = {};
                        let sort = false;
                        msgs.forEach(msg => keys[msg.id] = msg.time);
                        data.forEach(msg => {
                            // Ê£ÄÊµãÂ¶ÇÊûúÊ∂àÊÅØid‰∏çÂ≠òÂú®Âàô‰øùÂ≠òÊ∂àÊÅØ
                            if (keys[msg.id] == undefined) {
                                msgs.push(msg);
                                sort = true;
                            }
                        });
                        // ÁªôÊ∂àÊÅØËøõË°åÊéíÂ∫è
                        if (sort) msgs.sort((a, b) => a.time - b.time);
                        if (topicId == this.selectTopicId) this.readMsgList();
                        if (monitorAddMsg) this.monitorAddMsg();
                    }
                })
            },
            updateTableSize() {
                if (!tableContainerE || tableContainerE.clientWidth == 0 || scanTableContainerTime < Date.now()) {
                    // Â¶ÇÊûúÊó†Ê≥ïËØªÂèñÂà∞ÂÆΩÂ∫¶ÂàôÈáçÊñ∞Ëé∑ÂèñtableÂÆπÂô®
                    tableContainerE = document.querySelector('.table-container');
                    scanTableContainerTime = Date.now() + 1000;
                }
                if (tableContainerE) {
                    this.tableWidth = tableContainerE.clientWidth;
                    this.tableHeight = tableContainerE.clientHeight;
                }
                // ËÆ°ÁÆóÂ∑¶‰æßÂÆΩÂ∫¶ this.leftWidth .left-container
                if (!leftContainerE || leftContainerE.clientWidth == 0 || scanLeftContainerTime < Date.now()) {
                    // Â¶ÇÊûúÊó†Ê≥ïËØªÂèñÂà∞ÂÆΩÂ∫¶ÂàôÈáçÊñ∞Ëé∑ÂèñtableÂÆπÂô®
                    leftContainerE = document.querySelector('.left-container');
                    scanLeftContainerTime = Date.now() + 1000;
                }
                if (leftContainerE) {
                    this.leftWidth = leftContainerE.clientWidth;
                }
            },
            handlePasswordEnter(regMode) {
                if (this.login.register) {
                    if (regMode) this.handleRegister();
                } else {
                    this.handleLogin();
                }
            },
            handleLogin() {
                warpFetch(() => fetch(API_PREFIX + '/user/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ...this.login.form, password: encryptToBase64(this.login.form.password) })
                }), '#ÁôªÂΩïË¥¶Âè∑').then(data => {
                    if (data != null) {
                        this.login.form.password = '';
                        loginState.value = true;
                        this.readUserInfo();
                        ElMessage.success(this.login.form.username + ' ' + i18n('ÁôªÂΩïÊàêÂäü!'));
                        this.login.loginPageVisible = false;
                    }
                });
            },
            handleLogout() {
                warpFetch(() => fetch(API_PREFIX + '/user/logout'), 'Ê≥®ÈîÄÁôªÂΩï').then(data => {
                    ElMessage.success(i18n('Â∑≤Ê≥®ÈîÄÁôªÂΩï'));
                    Object.keys(this.user).forEach(k => this.user[k] = '');
                    loginState.value = false;
                    Object.assign(this.user, {
                        // ÈªòËÆ§‰ø°ÊÅØ
                        username: '',
                        userId: -1,
                        avatar: '',
                        showAvatar: '',
                    });
                });
            },
            async handleRegister() {
                if (this.login.form.password != this.login.form.password2) {
                    ElMessage.warning(i18n('ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥ÔºÅ'));
                    return;
                }
                const pdSalt = await this.passwordSalt(this.login.form.password);
                warpFetch(() => fetch(API_PREFIX + '/user/signUp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ...this.login.form, password: pdSalt })
                }), '#Ê≥®ÂÜåË¥¶Âè∑').then(data => {
                    this.login.form.password = '';
                    loginState.value = true;
                    this.readUserInfo();
                    ElMessage.success(this.login.form.username + ' ÁôªÂΩïÊàêÂäü!');
                    this.login.loginPageVisible = false;
                });
            },
            async updatePassword(showUser) {
                if (!showUser) showUser = this.editUser;
                if (showUser.password != showUser.password2) {
                    return ElMessage.warning(i18n('ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥ÔºÅ'));
                }
                if (typeof showUser.oldPassword != 'string' || showUser.oldPassword.length < 1) {
                    return ElMessage.warning(i18n('ËØ∑ËæìÂÖ•ÊóßÂØÜÁ†ÅÔºÅ'));
                }
                const pdSalt = await this.passwordSalt(showUser.password);
                const oldPdSalt = await this.passwordSalt(showUser.oldPassword);
                warpFetch(() => fetch(API_PREFIX + '/user/updatePassword', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: pdSalt,
                        oldPassword: oldPdSalt,
                    })
                }), '‰øÆÊîπÂØÜÁ†Å').then(data => {
                    ElMessage.success(i18n('ÂØÜÁ†Å‰øÆÊîπÊàêÂäü!'));
                });
            },
            async updateAccount(showUser) {
                let pdSalt = null;
                if (showUser.password) pdSalt = await this.passwordSalt(showUser.password);
                warpFetch(() => fetch(API_PREFIX + '/user/updateAccount', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user: { ...showUser, ...(pdSalt ? { password: pdSalt } : {}) } })
                }), '‰øÆÊîπ‰ø°ÊÅØ').then(data => {
                    this.readUserInfo();
                    ElMessage.success(i18n('‰øÆÊîπÊàêÂäü!'));
                });
            },
            // copyToUser(user){
            //     for (const key in user) {
            //         this.user[key] = user[key];
            //     }
            // },
            readUserInfo(userId) {
                warpFetch(() => fetch(API_PREFIX + '/user/info' + (userId != undefined ? '?userId=' + userId : '')
                ), '#Áî®Êà∑‰ø°ÊÅØ').then(data => {
                    if (!data) return;
                    data = reactive(data);
                    console.log('Áî®Êà∑‰ø°ÊÅØ', data)
                    if (new Date(data.deadline).toString() == 'Invalid Date') {
                        data.deadline = 0;
                    }
                    // Â∞ùËØï‰∏ãËΩΩÂ§¥ÂÉè‰ø°ÊÅØ
                    this.completeAvatarImage(data);

                    loginState.value = true;
                    if (userId == undefined) {
                        // ÊääÁî®Êà∑‰ø°ÊÅØÊ∑ªÂä†Âà∞ user ÈáåÈù¢
                        this.user = data;
                        this.editUser = data;
                        // Âà∑Êñ∞ÂÆåÁî®Êà∑‰ø°ÊÅØÂêéÂà∑Êñ∞Êï∞ÊçÆÂàóË°®
                        this.handleSwitchChange();
                    } else {
                        this.showUser = data;
                        if (this.showUser.userId == this.editUser.userId) {
                            this.editUser = data;
                        }
                        if (this.user.userId == data.userId) {
                            this.user = data;
                        }
                    }
                }).finally(a => {
                    if (this.fristLoadUserInfo) {
                        if (this.user.userId == -1) {
                            // ÊâìÂºÄÁôªÂΩïÁïåÈù¢
                            this.login.loginPageVisible = true;
                        }
                        this.fristLoadUserInfo = false
                    }
                });
            },
            handleEditAvatarChange() {
                this.editUser.showAvatar = '';
                this.completeAvatarImage(this.editUser);
            },
            downloadAvatarImage(url) {
                if (url) {
                    return fetch(url, { mode: 'cors' }).then(r => r.blob()).then(blob => {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = () => reject(new Error('FileReader error'));
                            reader.readAsDataURL(blob);
                        });
                    })
                } else console.log(i18n('Êó†ÊïàÁöÑÂ§¥ÂÉèÂú∞ÂùÄ'), url)
            },
            onAbout() {
                ElMessage(this.version)
            },
            onReload() {
                location.reload()
            },
            onClearCache() {
                clearCaches().then(r => {
                    ElMessage.success(i18n('ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§'));
                    setTimeout(this.onReload, 500);
                }).catch(e => {
                    ElMessage.error(i18n('Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•'));
                });
            },
            copyContent(content) {
                // Â§çÂà∂ÂÜÖÂÆπÂà∞Ââ™Ë¥¥Êùø
                navigator.clipboard.writeText(content).then(() => {
                    this.$message.success('copy succeed!');
                }).catch(() => {
                    this.$message.error('copy error!');
                });
            },
            selectAndChangMode(id, type, event) {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                event?.stopPropagation?.();

                let targetList = this.onlineSelect;
                if (type == 'msgs') {
                    targetList = this.msgsSelect;
                }

                const index = targetList.indexOf(id);
                if (-1 < index) {
                    targetList.splice(index, 1);
                } else {
                    targetList.push(id);
                }
            },
            createTopicApi(opts) {
                if (!Array.isArray(opts.addUserIds)) {
                    return;
                }

                const index = opts.addUserIds.findIndex(id => id == this.user.userId);
                if (-1 < index) opts.addUserIds.splice(index, 1);

                if (!opts.name) opts.name = new Date().toLocaleString();

                warpFetch(() => fetch(API_PREFIX + '/msg/createTopic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(opts)
                }), i18n('ÂàõÂª∫ËØùÈ¢ò')).then(data => {
                    ElMessage.success(data.name + ' ' + i18n('ËØùÈ¢òÂàõÂª∫ÊàêÂäü!'));
                });
            },
            createTopic() {
                let onlineSelectIds = this.onlineSelect.filter(userId => userId != this.user.userId);
                ElMessageBox.prompt(i18n('‰Ω†Á°ÆÂÆöË¶ÅÂàõÂª∫‰∏Ä‰∏™ËØùÈ¢òÂêóÔºü'),
                    i18n('ÂàõÂª∫{num}ÂÖ∂‰ªñ‰∫∫ÁöÑËØùÈ¢ò').replace('{num}', onlineSelectIds.length), {
                    confirmButtonText: i18n('Á°ÆÂÆö'),
                    cancelButtonText: i18n('ÂèñÊ∂à'),
                    inputPlaceholder: i18n('ËØ∑ËæìÂÖ•ËØùÈ¢òÂêçÁß∞'),
                    inputValidator: (value) => {
                        if (!value) {
                            return i18n('ËØùÈ¢òÂêçÁß∞‰∏∫Á©∫');
                        }
                        return true;
                    },
                    inputErrorMessage: i18n('Êó†ÊïàÁöÑËæìÂÖ•'),
                    type: 'warning',
                }).then(({ value }) => {
                    // Ë∞ÉÁî®ÂàõÂª∫ËØùÈ¢òÁöÑ API
                    this.createTopicApi({
                        addUserIds: [...new Set(onlineSelectIds)],
                        name: value,
                    });
                }).catch(() => { });
            },
            deleteTopicApi(topicIds) {
                if (!Array.isArray(topicIds) || topicIds.length < 1) return;
                warpFetch(() => fetch(API_PREFIX + '/msg/deleteTopic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ topicIds })
                }), i18n('Âà†Èô§ËØùÈ¢ò')).then(data => {
                    ElMessage.success(data.length + ' ' + i18n('ËØùÈ¢òÂà†Èô§ÊàêÂäü!'));
                });
            },
            deleteTopic() {
                // ÈÄâÊã©Ëá™Â∑±ÁöÑËØùÈ¢ò
                let names = [];
                const sa = this.user.superAdmin;
                let topicIds = this.msgsSelect.filter(topicId => {
                    let topic = this.msgsListData?.find(t => t.topicId == topicId);
                    if (sa || topic?.admins?.[0] == this.user?.userId) {
                        names.push(topic.name);
                        return true;
                    }
                    return false;
                });
                if (topicIds.length < 1) {
                    ElMessage.warning(i18n('ËØ∑ÈÄâÊã©Ëá≥Â∞ë1‰∏™Ëá™Â∑±ÁöÑËØùÈ¢ò'));
                    return;
                }
                ElMessageBox.confirm(i18n('Âà†Èô§{num}‰∏™ËØùÈ¢ò').replace('{num}', topicIds.length) + ` '${names.join("', '")}'`,
                    i18n('‰Ω†Á°ÆÂÆöË¶ÅÂà†Èô§ËØùÈ¢òÂêóÔºü'), {
                    confirmButtonText: i18n('Á°ÆÂÆö'),
                    cancelButtonText: i18n('ÂèñÊ∂à'),
                    type: 'warning',
                }).then(({ value }) => {
                    // Ë∞ÉÁî®Âà†Èô§ËØùÈ¢òÁöÑ API
                    this.deleteTopicApi(topicIds);
                }).catch(() => { });
            },
            async runMsgInIframe(msg, iframe) {
                let data = await this.runMsg(msg, true);
                iframe.contentWindow.document.body.innerHTML = data;
            },
            async runMsg(msg, closeShowText) {
                let fun = runMsgMap[msg.type];
                if (typeof fun != 'function') {
                    fun = (text) => text;
                }
                let re = await fun(msg.content);
                if (!closeShowText) this.showText(typeof re == 'string' ? re.replaceAll('\n', '<br>') : re, i18n('Á±ªÂûã', true) + ': ' + msg.type, re);
                return re;
            },
            showText(body, title, bodyOrg) {
                let that = this;
                ElMessageBox.alert(body, title, {
                    dangerouslyUseHTMLString: true,
                    confirmButtonText: i18n('Â§çÂà∂', true),
                    callback: action => {
                        if (action == 'confirm') {
                            that.copyContent(bodyOrg ?? body)
                        }
                    }
                })
            },
            showUserInfoPageByUserId(userId) {
                this.handleOnlineSelect(userId);
            },
            clickWelcome() {
                this.startNumber++;
                ElMessage.success('' + this.startNumber)
            },
            showNotFoundText() {
                // TextMap.__notFound
                this.showText(Object.keys(TextMap.__notFound).join('<br>'),
                    i18n('Êú™ÂëΩ‰∏≠ÁöÑÂõΩÈôÖÂåñÂ≠óÊÆµÊï∞Èáè'), JSON.stringify(TextMap.__notFound, null, 2));
            },
            changeNothidePage(left) {
                if (left) this.nothidePage.left = !this.nothidePage.left;
                else this.nothidePage.right = !this.nothidePage.right;
            },
            checkRows() {
                try {
                    if (this.useEditor) {
                        // monacoEditor ËæìÂÖ•Ê°Ü
                        const lineCount = monacoEditor.getModel().getLineCount();
                        if (this.currentRows != lineCount) {
                            this.currentRows = lineCount;
                        }
                    } else {
                        // ËæìÂÖ•Ê°Ü
                        this.$nextTick(() => {
                            const textarea = this.$refs.inputRef.$el.querySelector("textarea"); // Ëé∑Âèñ textarea ÂÖÉÁ¥†
                            if (textarea) {
                                const height = parseFloat(window.getComputedStyle(textarea).height); // Ëé∑Âèñ textarea ÁöÑÂÆûÈôÖÈ´òÂ∫¶
                                const lineHeight = parseFloat(window.getComputedStyle(textarea).lineHeight); // Ëé∑ÂèñÊØèË°åÁöÑÈ´òÂ∫¶
                                this.currentRows = Math.floor(height / lineHeight); // ËÆ°ÁÆóË°åÊï∞
                            }
                        });
                    }
                } catch (err) { }
            },
            copyOriginData() {
                this.copyContent(this.originData)
            },
            copyCryptoData() {
                this.copyContent(this.cryptoData)
            },
            onCryptoData(decode) {
                warpFetch(() => fetch(API_PREFIX + '/cryptoDB', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        decode: !!decode,
                        data: decode ? this.cryptoData : this.originData,
                        key: this.cryptoKey,
                    })
                }), i18n('Âä†Ëß£ÂØÜÊï∞ÊçÆ')).then(data => {
                    if (typeof data == 'object') data = JSON.stringify(data);
                    if (decode) {
                        this.originData = '' + data;
                    } else {
                        this.cryptoData = '' + data;
                    }
                });
            },
            selectFile() {
                this.fileName = i18n('ÈÄâÊã©Êñá‰ª∂‰∏≠...');
                document.getElementById('fileInput').click();
                this.selectFileNameTimerId = setTimeout(() => this.fileName = '', 5000)
            },
            handleFileChange(event) {
                clearTimeout(this.selectFileNameTimerId);
                const files = event.target.files;
                this.files = (files ? Array.from(files) : []) || [];
                if (this.files && 0 < this.files.length) {
                    const selectedFile = files[0];
                    // Êõ¥Êñ∞Êñá‰ª∂Âêç
                    if (1 < this.files.length) this.fileName = `(${this.files.length}) ${selectedFile.name}`;
                    else this.fileName = selectedFile.name;
                } else {
                    this.fileName = '';
                }
            },
            async initXxHash() {
                // ÂàùÂßãÂåñxxHash
                try {
                    this.xxHasher = await xxhash();
                    console.log(i18n('xxHash-WASM ÂàùÂßãÂåñÂÆåÊàê'));
                    if (!this.xxHasher) throw new Error('xxhash is error')
                } catch (err) {
                    console.error(i18n('xxHashÂàùÂßãÂåñÂ§±Ë¥•'), err);
                    ElMessage.error(i18n('ÂìàÂ∏åËÆ°ÁÆóÂäüËÉΩ‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞È°µÈù¢'));
                    throw new Error(i18n('ÂìàÂ∏åËÆ°ÁÆóÂäüËÉΩ‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞È°µÈù¢'))
                }
            },
            // ËÆ°ÁÆóÊñá‰ª∂ÂìàÂ∏åÔºàÈÄÇÈÖçÂêéÁ´ØxxHashJSÁöÑ32‰ΩçÁâàÊú¨Ôºâ
            async calculateFileHash(file) {
                if (!this.xxHasher) await this.initXxHash();

                const chunkSize = 2 * 1024 * 1024; // 2MBÂàÜÁâá
                const chunks = Math.ceil(file.size / chunkSize);
                const seed = 8866; // ‰∏éÂêéÁ´Ø‰øùÊåÅ‰∏ÄËá¥ÁöÑÁßçÂ≠ê

                // ‰ΩøÁî®32‰ΩçÂìàÂ∏å‰ª•ÂåπÈÖçÂêéÁ´ØXXHashJS
                const hash = this.xxHasher.create32(seed);

                for (let i = 0; i < chunks; i++) {
                    const chunk = file.slice(i * chunkSize, (i + 1) * chunkSize);
                    const buffer = await chunk.arrayBuffer();
                    hash.update(new Uint8Array(buffer));
                }

                return hash.digest().toString(16).padStart(8, '0');
            },
            async upFile(file, ppcb) {
                try {
                    if (!file) {
                        throw new Error(i18n('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂'))
                    }
                    let fn = file.name;
                    let fileHash;
                    if (!this.filesHashCache[fn]) {
                        showLog("Ê≠£Âú®ËÆ°ÁÆóÊñá‰ª∂ÂìàÂ∏å...");
                        fileHash = this.filesHashCache[fn] = await this.calculateFileHash(file);
                        showLog(`Êñá‰ª∂Ê†°È™å‰∏≠ (xxHash: ${fileHash.substring(0, 8)}...)`);
                    } else fileHash = this.filesHashCache[fn];

                    // ÂàùÂßãÂåñ‰∏ä‰º†ÔºàÊ£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®Ôºâ
                    const initResponse = await fetch('/uploads/init', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: file.name,
                            fileSize: file.size,
                            fileHash: fileHash
                        })
                    });

                    const initData = await initResponse.json();

                    if (initData.skipUpload) {
                        showLog(`Êñá‰ª∂Â∑≤Â≠òÂú® ${initData.message}`);
                        return initData;
                    }

                    // Ê†ºÂºèÂåñÂ≠óËäÇÂ§ßÂ∞è
                    function formatBytes(bytes, decimals = 2) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const dm = decimals < 0 ? 0 : decimals;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                    }
                    // ÈÖçÁΩÆTUS‰∏ä‰º†
                    currentUpload = new tus.Upload(file, {
                        endpoint: '/uploads/files',
                        uploadUrl: initData.tusEndpoint,
                        metadata: {
                            filename: file.name,
                            filetype: file.type,
                            filehash: fileHash
                        },
                        chunkSize: 5 * 1024 * 1024, // Êï∞ÊçÆÂàÜÁâá5MBÂàÜÁâá
                        retryDelays: [0, 1000, 3000, 5000],
                        onError: (error) => {
                            console.error("‰∏ä‰º†Â§±Ë¥•:", error);
                        },
                        onProgress: (bytesUploaded, bytesTotal) => {
                            const percent = Math.round((bytesUploaded / bytesTotal) * 100);
                            showLog(`‰∏ä‰º†ËøõÂ∫¶: ${percent}% (${formatBytes(bytesUploaded)}/${formatBytes(bytesTotal)})`);
                            if (typeof ppcb == 'function') ppcb(bytesUploaded, bytesTotal, percent)
                        },
                        onSuccess: () => {
                            console.info("‰∏ä‰º†ÂÆåÊàêÔºÅ");
                        }
                    });

                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™ÂÆåÊàêÁöÑ‰∏ä‰º†
                    const previousUploads = await currentUpload.findPreviousUploads();
                    if (previousUploads.length > 0) {
                        console.log("Ê£ÄÊµãÂà∞Êú™ÂÆåÊàêÁöÑ‰∏ä‰º†ÔºåËá™Âä®Áª≠‰º†...");
                        currentUpload.resumeFromPreviousUpload(previousUploads[0]);
                    }

                    currentUpload.start();
                } catch (error) {
                    console.error("‰∏ä‰º†ÈîôËØØ:", error);
                    ElMessage.error(`‰∏ä‰º†Â§±Ë¥•: ${error.message}`);
                    return error
                }
            },
            async uploadFiles() {
                this.uploadedFiles = [];
                let end = false;
                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    let prefix = i18n('‰∏ä‰º†‰∏≠...') + `(${i}/${this.files.length})`;
                    this.fileName = prefix + `[${i18n('Ê≠£Âú®ËÆ°ÁÆóÊñá‰ª∂ÂìàÂ∏å...')}]`;
                    let re = await this.upFile(file, (a, b, pp) => {
                        console.log('pp', pp)
                        if (100 <= pp && end) this.fileName = `(${this.files.length}) ` + i18n('Â∑≤ÂÖ®ÈÉ®‰∏ä‰º†');
                        else this.fileName = prefix + `[${pp}%]`
                    });
                    if (re?.fileId) {
                        this.uploadedFiles.push(re.fileId);
                        this.writeText(this.inmsg + `\n${re.fileId}`);
                    }
                }
                end = true;
                this.fileName = `(${this.files.length}) ` + i18n('Â∑≤ÂÖ®ÈÉ®‰∏ä‰º†');
            },
            clearFiles() {
                try {
                    this.files.splice(0, this.files.length);
                } catch (err) {
                    this.uploadedFiles = []
                }
                this.fileName = '';
            },
            clearUploadedFiles() {
                this.uploadedFiles.splice(0, this.uploadedFiles.length);
            },
            fileUrl(url) {
                return url.startsWith('http') ? url : ('/uploads/down/' + url);
            },
            /**
             * ÂèëÈÄÅÊñá‰ª∂ÂàóË°®
             */

            async sendFiles() {
                const files = [...this.uploadedFiles];

                // ÈÄíÂΩíÂ§ÑÁêÜÈòüÂàó
                const processNext = async (index = 0) => {
                    if (index >= files.length) return; // ÊâÄÊúâÊñá‰ª∂Â§ÑÁêÜÂÆåÊàê

                    const fn = files[index];
                    if (!fn) {
                        console.error(i18n('Êó†ÊïàÁöÑÊ∂àÊÅØÂÜÖÂÆπ'), fn);
                        return processNext(index + 1);
                    }

                    try {
                        // ÂåÖË£ÖsendMsg‰∏∫PromiseÔºå‰ª•‰æøawait
                        await new Promise((resolve, reject) => {
                            this.sendMsg({
                                topicId: this.selectTopicId,// Ê∂àÊÅØIDÔºå‰πüÂ∞±ÊòØÊñá‰ª∂ÂêçÂ≠ó
                                userId: this.user.userId,   // ÂΩìÂâçÁî®Êà∑idÔºåÁî®‰∫éÊ£ÄÈ™åÊòØÂê¶ÊúâÊùÉÈôê
                                sendTime: Date.now(),       // ÂèëÈÄÅÊó∂Èó¥
                                // time: Date.now(),        // ÊúçÂä°Âô®Êî∂Âà∞ÁöÑÊó∂Èó¥
                                senderror: false,           // ÂèëÈÄÅÂ§±Ë¥•ÔºåÂ¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•Âàô‰ºöÂèòÊàêÈîôËØØ‰ø°ÊÅØ
                                content: fn,                // Ê∂àÊÅØ
                                type: 'image'
                            }, 0, (data) => {
                                // ‰ªéuploadedFiles‰∏≠ÁßªÈô§Â∑≤ÂèëÈÄÅÊñá‰ª∂
                                const i = this.uploadedFiles.indexOf(fn);
                                if (i !== -1) this.uploadedFiles.splice(i, 1);
                                resolve(data); // ÂõûË∞ÉÂÆåÊàêÔºåÁªßÁª≠‰∏ã‰∏Ä‰∏™
                            }
                            );
                        });
                    } catch (error) {
                        console.error('Êñá‰ª∂ÂèëÈÄÅÂ§±Ë¥•:', error);
                    } finally {
                        processNext(index + 1); // Êó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÔºåÁªßÁª≠‰∏ã‰∏Ä‰∏™
                    }
                };

                await processNext(0); // ‰ªéÁ¨¨‰∏Ä‰∏™Êñá‰ª∂ÂºÄÂßã
            },
            getPreviewTopicListIndex(content) {
                let index = this.previewTopicList.indexOf(this.fileUrl(content));
                return 0 <= index ? index : this.previewTopicList.length;
            },
            globalInte() {
                // Ê£ÄÊü•ÁõëÊéßÊòØÂê¶ÈÉΩÂú®Ôºå‰∏çÂú®Â∞±ÈáçÊñ∞ÂêØÂä®ÁõëÊéß
                if (!this.intes.m_getMsg) this.monitorAddMsg();
                if (!this.intes.m_onlineList) this.monitorGetOnlineList();
                if (!this.intes.m_topicList) this.monitorGetMsgsList();
            },
            /** ‰ΩøÁî® marked Ëß£Êûê Markdown */
            renderedMarkdownByMsg(msg) {
                return parseMarked(msg?.content || '');
            },
            initMonacoEditor() {
                this.editorStatus = false;
                let that = this;
                this.$nextTick(() => {
                    // ÂéüÂßãË∑ØÂæÑ https://unpkg.com/monaco-editor/min/vs
                    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor/min/vs' } });
                    require(['vs/editor/editor.main'], function () {
                        monacoEditor = monaco.editor.create(that.$refs.monacoEditor, {
                            value: that.inmsg,
                            language: 'javascript',
                            theme: 'vs',
                            automaticLayout: true,
                            wordWrap: 'on',
                            minimap: {
                                enabled: true,
                                autohide: true,     // Èº†Ê†á‰∏çÂú®Âè≥‰æßÊó∂Ëá™Âä®ÈöêËóè
                                showSlider: 'mouseover', // Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊªëÂùó

                            },
                            scrollBeyondLastLine: false,
                            lineNumbers: 'on',
                            folding: true,
                            lineDecorationsWidth: 0,
                            lineNumbersMinChars: 0,
                            padding: { top: 5, bottom: 5 },
                            fontSize: 14,
                            lineHeight: that.lineHeight,
                            renderWhitespace: 'none',
                            overviewRulerBorder: false,
                            hideCursorInOverviewRuler: true,
                            // showSlider: 'always', // ÂßãÁªàÊòæÁ§∫ÊªëÂùó
                            scrollbar: {
                                vertical: 'hidden',
                                horizontal: 'auto',
                                handleMouseWheel: true
                            }
                        });

                        // ËÆæÁΩÆ placeholder
                        monacoEditor.updateOptions({
                            placeholder: i18n('ËæìÂÖ•Ê∂àÊÅØ...')
                        });

                        // ÂÜÖÂÆπÂèòÂåñ‰∫ã‰ª∂
                        monacoEditor.onDidChangeModelContent(() => {
                            // that.inmsg = monacoEditor.getValue();
                            that.adjustEditorHeight(monacoEditor);
                            that.checkRows(); // Ë∞ÉÁî®ÂéüÊúâÁöÑË°åÊï∞Ê£ÄÊü•ÊñπÊ≥ï
                        });

                        // ÂàùÂßãË∞ÉÊï¥È´òÂ∫¶
                        that.adjustEditorHeight(monacoEditor, true);
                        this.editorStatus = true;
                    });
                })
            },
            readText() {
                var content = monacoEditor.getValue();
                return this.inmsg = content
            },
            writeText(text) {
                monacoEditor.setValue(text);
                return this.inmsg = text
            },
            /**
             * Ë∞ÉËäÇËæìÂÖ•Ê°ÜÁöÑÂÆΩÈ´ò
             */
            adjustEditorHeight(editor, focus) {
                try {
                    if (!editor) editor = monacoEditor;
                    const contentHeight = editor.getContentHeight();
                    const maxHeight = this.lineHeight * 20 + this.padding;
                    let currentRows = this.currentRows < 2 ? 2 : this.currentRows;
                    const rowsHeight = this.lineHeight * currentRows;
                    const useH = Math.min(contentHeight, maxHeight, rowsHeight);
                    if (focus) {
                        this.editorHeight = useH;
                    } else {
                        clearTimeout(this.adjustEditorHeightTimeout); // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
                        this.adjustEditorHeightTimeout = setTimeout(() => {
                            this.editorHeight = useH;
                        }, 300); // ËÆæÁΩÆ 300ms ÁöÑÂª∂Ëøü
                    }
                } catch (error) {
                    console.warn('Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶Â§±Ë¥•', error)
                }
            },
            upModelLanguage() {
                // Ëé∑ÂèñÂΩìÂâçÊ®°ÂûãÂπ∂ËÆæÁΩÆÊñ∞ËØ≠Ë®Ä
                const model = monacoEditor.getModel();
                monaco.editor.setModelLanguage(model, languageMap[this.msgTemplate.type] || this.msgTemplate.type); // ÂàáÊç¢‰∏∫JavaScriptËØ≠Ê≥ïÈ´ò‰∫Æ
            },
            async toggleNativeFullscreen() {
                if (!this.useEditor) {
                    ElMessage.info(i18n('ÊôÆÈÄöËæìÂÖ•Ê°ÜÊó†Ê≥ïÂºÄÂêØÂÖ®Â±èÊ®°Âºè'));
                    return;
                }
                const container = this.$refs.monacoEditor;

                try {
                    if (!document.fullscreenElement) {
                        await container.requestFullscreen();
                        container.style.background = 'white';
                    } else {
                        if (document.exitFullscreen) {
                            await document.exitFullscreen();
                        }
                    }
                    this.editor.layout();
                } catch (err) {
                    console.error('ÂÖ®Â±èÈîôËØØ:', err);
                }
            },
            onSaveDB() {
                warpFetch(() => fetch(API_PREFIX + '/msg/save'), i18n('‰øùÂ≠òÊï∞ÊçÆ'), () => { }).then(data => {
                    ElMessage.success(i18n('‰øùÂ≠òÊï∞ÊçÆ') + ' ' + data)
                });
            },
            sa_logoutAll() {
                // Ê≥®ÈîÄÊâÄÊúâÁôªÂΩï
                let onlineSelectIds = [...new Set(this.onlineSelect)];
                ElMessageBox.confirm(i18n('‰Ω†Á°ÆÂÆöË¶ÅÊ≥®ÈîÄËøô‰∫õÁî®Êà∑ÁöÑÁôªÂΩïÁä∂ÊÄÅÂêóÔºü'),
                    i18n('Ê≥®ÈîÄ{num}‰∫∫ÁöÑÁôªÂΩïÁä∂ÊÄÅ').replace('{num}', onlineSelectIds.length), {
                    confirmButtonText: i18n('Á°ÆÂÆö'),
                    cancelButtonText: i18n('ÂèñÊ∂à'),
                    type: 'warning',
                }).then(({ value }) => {
                    // ÊâπÈáèÊ≥®ÈîÄÁôªÂΩï
                    warpFetch(() => fetch(API_PREFIX + '/user/sa_logoutAll', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userIds: onlineSelectIds })
                    }), i18n('Ê≥®ÈîÄÁôªÂΩï')).then(data => {
                        ElMessage.success(i18n('Â∑≤Ê≥®ÈîÄÁôªÂΩï'));
                        this.getOnlineList(0);
                    });
                }).catch(() => { });
            },
            sa_onlineList() {
                warpFetch(() => fetch(API_PREFIX + '/user/sa_onlineList'), 'Ëé∑ÂèñÂÖ®ÈÉ®Âú®Á∫øÁî®Êà∑ÂàóË°®')
                    .then(data => {
                        this.onlineListData.splice(0, this.onlineListData.length, ...data);
                        this.completeAvatarImage(this.onlineListData);
                        this.sortShowOnlineListData();
                    });
            },
            completeAvatarImage(userList) {
                if (!Array.isArray(userList)) userList = [userList];
                userList.forEach(user => {
                    // Â∞ùËØï‰∏ãËΩΩÂ§¥ÂÉè‰ø°ÊÅØ
                    try {
                        if (user.avatar) {
                            if (this.avatarImageCache[user.avatar]) {
                                user.showAvatar = this.avatarImageCache[user.avatar]
                            } else {
                                this.downloadAvatarImage(user.avatar).then(base64Data => {
                                    this.avatarImageCache[user.avatar] = base64Data
                                    user.showAvatar = base64Data;
                                }).catch(e => {
                                    showLog('Â§¥ÂÉè‰∏ãËΩΩÂ§±Ë¥•', e)
                                })
                            }
                        }
                    } catch (error) {
                        showLog('Â§¥ÂÉèÂä†ËΩΩÂ§±Ë¥•', error)
                    }
                })
            },
            sa_topicList() {
                warpFetch(() => fetch(API_PREFIX + '/msg/sa_topicList'), 'Ëé∑ÂèñÂÖ®ÈÉ®ËØùÈ¢òÂàóË°®').then(data => {
                    this.msgsListData.splice(0, this.msgsListData.length, ...data);
                    this.sortShowMsgsListData();
                });
            },
            async passwordSalt(password) {
                return await warpFetch(() => fetch(API_PREFIX + '/user/passwordSalt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                }), 'Ëé∑ÂèñÂä†ÂØÜÂêéÁöÑÂØÜÁ†Å');
            },
            openTopicOptionsPage(topic) {
                console.log('topic', topic);
                this.editTopic = topic;
                this.selectRightPage(RightPageMap.editTopic);
            },
            onDeleteTopic(topic) {
                if (!topic) {
                    return;
                }
                // ÈÄâÊã©Ëá™Â∑±ÁöÑËØùÈ¢ò
                if (topic?.admins?.[0] != this.user?.userId) {
                    ElMessage.warning(i18n('Êó†Ê≥ïÂà†Èô§‰ªñ‰∫∫ÁöÑËØùÈ¢ò'));
                    return;
                }
                ElMessageBox.confirm(i18n('Âà†Èô§ËØùÈ¢ò'),
                    i18n('‰Ω†Á°ÆÂÆöË¶ÅÂà†Èô§ËØùÈ¢ò {name} ÂêóÔºü').replace('{name}', topic.name), {
                    confirmButtonText: i18n('Á°ÆÂÆö'),
                    cancelButtonText: i18n('ÂèñÊ∂à'),
                    type: 'warning',
                }).then(({ value }) => {
                    // Ë∞ÉÁî®Âà†Èô§ËØùÈ¢òÁöÑ API
                    this.deleteTopicApi([topic.topicId]);
                }).catch(() => { });
            },
            onUpdateTopic(topic) {
                if (!topic) {
                    return;
                }
                warpFetch(() => fetch(API_PREFIX + '/msg/updateTopic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(topic)
                }), i18n('Êõ¥Êñ∞ËØùÈ¢ò')).then(data => {
                    ElMessage.success(data.name + ' ' + i18n('ËØùÈ¢òÊõ¥Êñ∞ÊàêÂäü!'));
                });
            },
            onExitTopic(topic) {
                if (!topic) {
                    return;
                }
                ElMessageBox.confirm(i18n('ÈÄÄÂá∫ËØùÈ¢ò'),
                    i18n('‰Ω†Á°ÆÂÆöË¶ÅÈÄÄÂá∫ËØùÈ¢ò {name} ÂêóÔºü').replace('{name}', topic.name), {
                    confirmButtonText: i18n('Á°ÆÂÆö'),
                    cancelButtonText: i18n('ÂèñÊ∂à'),
                    type: 'warning',
                }).then(({ value }) => {
                    warpFetch(() => fetch(API_PREFIX + '/msg/exitTopic', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(topic)
                    }), i18n('ÈÄÄÂá∫ËØùÈ¢ò')).then(data => {
                        ElMessage.success(data.name + ' ' + i18n('ËØùÈ¢òÂ∑≤ÈÄÄÂá∫'));
                    });
                }).catch(() => { });

            },
        }
    })
        .use(ElementPlus)
        .mount('#app');
</script>